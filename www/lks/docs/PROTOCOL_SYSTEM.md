# Система протоколов KGB-Pulse

## Обзор

Система протоколов KGB-Pulse представляет собой комплексное решение для управления соревнованиями по гребле. Она включает в себя нумерацию протоколов, жеребьевку, защиту заполненных протоколов и завершение мероприятий.

## Основные компоненты

### 1. Нумерация протоколов (`protocol_numbering.php`)

Класс `ProtocolNumbering` обеспечивает последовательную нумерацию всех протоколов на основе:
- Класса лодки (K-1, K-2, K-4, C-1, C-2, C-4, D-10)
- Дистанции (200м, 500м, 1000м)
- Пола (М, Ж, MIX)
- Возрастной группы

**Порядок нумерации:**
1. По классу лодки (от меньшего к большему)
2. По дистанции (от меньшей к большей)
3. По полу (М, Ж, MIX)
4. По возрастной группе

### 2. Калькулятор возрастных групп (`age_group_calculator.php`)

Класс `AgeGroupCalculator` обрабатывает:
- Вычисление возраста участника на 31 декабря текущего года
- Определение возрастной группы на основе `class_distance`
- Поддержка групповых лодок (средний возраст экипажа)
- Специальная обработка драконов (D-10)

### 3. Защита протоколов

Система защищает заполненные протоколы от перезаписи:
- **Критерий защиты:** наличие места и времени финиша у участника
- **Визуальное отображение:** зеленая окантовка
- **Хранение:** флаг `protected: true` в Redis/JSON
- **Поведение:** защищенные протоколы не удаляются при новой жеребьевке

## API Endpoints

### Протоколы

#### `get_protocols_structure.php`
- **Назначение:** Получение структуры протоколов с нумерацией
- **Метод:** POST
- **Параметры:** `meroId`, `selectedDisciplines`
- **Ответ:** Структурированный список протоколов с номерами

#### `get_disciplines_status.php`
- **Назначение:** Проверка статуса заполненности дисциплин
- **Метод:** POST
- **Параметры:** `meroId`, `selectedDisciplines`
- **Ответ:** Статус каждой дисциплины (completed/partial/empty)

#### `add_participant_to_protocol.php`
- **Назначение:** Ручное добавление участника в протокол
- **Метод:** POST
- **Параметры:** `meroId`, `participantData`, `protocolInfo`
- **Функции:**
  - Создание/обновление записи в `listreg`
  - Добавление в стартовый и финишный протоколы
  - Сохранение в Redis и JSON

#### `search_participants.php`
- **Назначение:** Поиск участников для добавления
- **Метод:** POST
- **Параметры:** `searchTerm`, `limit`
- **Ответ:** Список участников с основной информацией

### Завершение мероприятий

#### `finalize_event.php`
- **Назначение:** Финальное завершение мероприятия
- **Метод:** POST
- **Параметры:** `meroId`
- **Функции:**
  - Сохранение результатов в `user_statistic`
  - Обновление статуса мероприятия на 'Завершено'
  - Логирование события

#### `download_final_protocol.php`
- **Назначение:** Скачивание итогового протокола
- **Метод:** POST
- **Параметры:** `meroId`
- **Формат:** PDF (планируется)

#### `download_award_sheets.php`
- **Назначение:** Скачивание наградных ведомостей
- **Метод:** POST
- **Параметры:** `meroId`
- **Формат:** ZIP с PDF файлами (планируется)

## Структура данных

### Redis ключи

```
protocol:start:{meroId}:{class}:{sex}:{distance}:{ageGroup}
protocol:finish:{meroId}:{class}:{sex}:{distance}:{ageGroup}
```

### Структура данных протокола

```json
{
  "meroId": 123,
  "discipline": "K-1",
  "sex": "М",
  "distance": "200",
  "ageGroup": "группа 1: 18-29",
  "type": "start",
  "participants": [
    {
      "userId": 1001,
      "fio": "Иванов И.И.",
      "sex": "М",
      "birthdata": "1995-06-15",
      "sportzvanie": "КМС",
      "teamName": "Команда А",
      "teamCity": "Москва",
      "lane": 1,
      "place": null,
      "finishTime": null,
      "addedManually": true,
      "addedAt": "2024-01-15 10:30:00"
    }
  ],
  "protected": false,
  "created_at": "2024-01-15 10:00:00",
  "redisKey": "protocol:start:123:K-1:M:200:группа_1_18-29"
}
```

## JavaScript компоненты

### ProtocolsManager

Основной класс для управления протоколами:

#### Методы
- `loadProtocolsStructure()` - Загрузка структуры протоколов
- `renderProtocolsData()` - Отрисовка данных протоколов
- `addParticipantToProtocol()` - Добавление участника
- `showAddParticipantModal()` - Показ модального окна
- `searchParticipants()` - Поиск участников
- `isProtocolProtected()` - Проверка защиты протокола

#### События
- Автоматическое обновление при изменении данных
- Визуальная индикация защищенных протоколов
- Поиск и выбор участников

## Визуальные индикаторы

### Статусы дисциплин
- **Зеленый контур:** Все протоколы заполнены
- **Желтый контур:** Частично заполнены
- **Без контура:** Пустые

### Защищенные протоколы
- **Зеленая окантовка:** Протокол защищен от перезаписи
- **Зеленый фон заголовка:** Визуальное подтверждение защиты

## Рабочий процесс

### 1. Создание протоколов
1. Выбор мероприятия
2. Выбор дисциплин
3. Генерация структуры протоколов с нумерацией
4. Отображение на странице

### 2. Жеребьевка
1. Нажатие кнопки "Жеребьевка"
2. Очистка незащищенных протоколов
3. Распределение участников по возрастным группам
4. Сохранение в Redis и JSON

### 3. Ручное добавление участников
1. Нажатие "Добавить участника"
2. Поиск участника по номеру или ФИО
3. Выбор участника из результатов
4. Заполнение дополнительной информации
5. Сохранение в протокол и базу данных

### 4. Заполнение результатов
1. Ввод мест и времен в финишные протоколы
2. Автоматическая защита заполненных протоколов
3. Визуальная индикация защиты

### 5. Завершение мероприятия
1. Проверка заполненности всех дисциплин
2. Нажатие "Завершить мероприятие"
3. Сохранение результатов в `user_statistic`
4. Обновление статуса мероприятия
5. Генерация итоговых документов

## Тестирование

### Запуск тестов
```bash
cd /lks/tests
php test_protocol_system.php
```

### Тестируемые компоненты
- Нумерация протоколов
- Калькулятор возрастных групп
- Redis операции
- Операции с базой данных

## Безопасность

### Авторизация
- Проверка ролей (Secretary, SuperUser, Admin)
- Валидация входных данных
- Защита от SQL-инъекций

### Защита данных
- Prepared statements
- Санитизация пользовательского ввода
- Логирование критических операций

## Мониторинг

### Логирование
- Создание протоколов
- Жеребьевка
- Добавление участников
- Защита протоколов
- Завершение мероприятий

### Метрики
- Количество созданных протоколов
- Статистика защищенных протоколов
- Время выполнения операций

## Планы развития

### Краткосрочные
- [ ] PDF генерация итоговых протоколов
- [ ] ZIP архивирование наградных ведомостей
- [ ] Улучшение поиска участников

### Долгосрочные
- [ ] Интеграция с системой уведомлений
- [ ] Мобильная версия для судей
- [ ] Автоматическая синхронизация результатов 