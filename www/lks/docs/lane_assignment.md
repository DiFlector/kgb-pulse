# Система назначения дорожек в протоколах

## Обзор

Система автоматического назначения дорожек позволяет секретарю проводить жеребьевку участников с автоматическим распределением по дорожкам в зависимости от типа лодки.

## Типы лодок и количество дорожек

### Драконы (D-10)
- **Максимальное количество дорожек**: 6
- **Причина**: Ограничения по ширине трассы для драконов

### Обычные лодки (K-1, K-2, K-4, C-1, C-2, C-4)
- **Максимальное количество дорожек**: 9
- **Причина**: Стандартная ширина трассы

## Порядок отображения протоколов

Протоколы отображаются в строго определенном порядке:

1. **D-10** (Драконы)
2. **K-1** (Байдарки одиночки)
3. **C-1** (Каноэ одиночки)
4. **K-2** (Байдарки двойки)
5. **C-2** (Каноэ двойки)
6. **K-4** (Байдарки четверки)
7. **C-4** (Каноэ четверки)
8. **HD-1** (Специальные классы)
9. **OD-1** (Специальные классы)
10. **OD-2** (Специальные классы)
11. **OC-1** (Специальные классы)

### Алгоритм сортировки
```php
$boatOrder = [
    'D-10' => 1,
    'K-1' => 2,
    'C-1' => 3,
    'K-2' => 4,
    'C-2' => 5,
    'K-4' => 6,
    'C-4' => 7,
    'HD-1' => 8,
    'OD-1' => 9,
    'OD-2' => 10,
    'OC-1' => 11
];
```

## Алгоритм назначения дорожек

### Автоматическое назначение
1. **Перемешивание участников**: Случайное распределение участников в группе
2. **Последовательное назначение**: Дорожки назначаются с 1 по максимальную
3. **Циклическое распределение**: Если участников больше чем дорожек, начинаем сначала с дорожки 1

### Примеры

#### Драконы (6 дорожек)
```
Участник 1 → Дорожка 1
Участник 2 → Дорожка 2
Участник 3 → Дорожка 3
Участник 4 → Дорожка 4
Участник 5 → Дорожка 5
Участник 6 → Дорожка 6
Участник 7 → Дорожка 1 (цикл)
Участник 8 → Дорожка 2
```

#### Обычные лодки (9 дорожек)
```
Участник 1 → Дорожка 1
Участник 2 → Дорожка 2
...
Участник 9 → Дорожка 9
Участник 10 → Дорожка 1 (цикл)
```

## Возможности секретаря

### Изменение дорожек
Секретарь может изменять назначенные дорожки вручную:

1. **Валидация**: Проверка на допустимые значения (1-6 для драконов, 1-9 для обычных лодок)
2. **Проверка занятости**: Нельзя назначить дорожку, которая уже занята
3. **Визуальная индикация**: Измененные дорожки выделяются цветом

### Интерфейс управления
- **Поле ввода**: Числовое поле с ограничениями
- **Индикатор изменений**: Визуальное выделение измененных дорожек
- **Уведомления**: Сообщения об успешном изменении или ошибках

## API функции

### Обновление дорожки
**Endpoint**: `/lks/php/secretary/update_lane.php`

**Параметры**:
- `meroId` - ID мероприятия
- `groupKey` - Ключ группы участников
- `userId` - ID участника
- `newLane` - Новый номер дорожки

**Ответ**:
```json
{
    "success": true,
    "message": "Дорожка успешно изменена на 3",
    "newLane": 3,
    "maxLanes": 9
}
```

### Проведение жеребьевки
**Endpoint**: `/lks/php/secretary/conduct_draw.php`

**Функциональность**:
- Автоматическое перемешивание участников
- Назначение дорожек по алгоритму
- Сохранение данных в Redis и JSON файлах

## Валидация

### Проверки при изменении дорожки
1. **Диапазон значений**: Дорожка должна быть в допустимом диапазоне
2. **Занятость**: Дорожка не должна быть занята другим участником
3. **Тип лодки**: Учитывается максимальное количество дорожек для типа лодки

### Сообщения об ошибках
- "Номер дорожки должен быть от 1 до 6" (для драконов)
- "Номер дорожки должен быть от 1 до 9" (для обычных лодок)
- "Дорожка X уже занята другим участником"

## Визуальные элементы

### CSS классы
- `.lane-input` - Поле ввода дорожки
- `.lane-input.modified` - Измененная дорожка
- `.participant-row.border-warning` - Строка с измененной дорожкой
- `.lane-modified-indicator` - Индикатор изменений

### Анимации
- Анимация при изменении дорожки
- Плавные переходы при наведении
- Визуальная обратная связь

## Тестирование

### Запуск тестов
```bash
cd www/lks/tests
php test_lane_assignment.php
```

### Тестовые сценарии
1. **Назначение дорожек для драконов** - Проверка корректности для 6 дорожек
2. **Назначение дорожек для обычных лодок** - Проверка корректности для 9 дорожек
3. **Валидация дорожек** - Проверка ограничений по типам лодок

## Безопасность

### Проверки доступа
- Только секретари, суперпользователи и администраторы могут изменять дорожки
- Проверка авторизации на каждом запросе

### Валидация данных
- Проверка типов данных
- Санитизация входных параметров
- Защита от SQL-инъекций

## Логирование

### События для логирования
- Изменение дорожки участника
- Проведение жеребьевки
- Ошибки валидации
- Попытки несанкционированного доступа

### Формат логов
```
[2024-01-15 10:30:15] LANE_UPDATE: Участник 1001 изменена дорожка с 3 на 5 (Группа: 123_K-1_M_200_группа 1)
[2024-01-15 10:30:20] DRAW_CONDUCTED: Жеребьевка проведена для протокола K-1_M_200
```

## Интеграция с существующей системой

### Совместимость
- Работает с существующей системой протоколов
- Не влияет на другие функции
- Обратная совместимость с существующими данными

### Миграция данных
- Автоматическое добавление полей для дорожек
- Сохранение существующих данных
- Плавный переход на новую систему

## Планы развития

### Будущие улучшения
1. **Массовое изменение дорожек** - Изменение нескольких дорожек одновременно
2. **Автоматическая оптимизация** - Распределение по оптимальным дорожкам
3. **Интеграция с таймерами** - Связь дорожек с системой хронометража
4. **Экспорт в Excel** - Включение дорожек в экспортируемые протоколы 