# Система генерации CSV протоколов

## Обзор

Система генерации CSV протоколов позволяет создавать стартовые протоколы в формате CSV на основе шаблонов и данных из JSON файлов протоколов.

## Структура файлов

### Основные файлы
- `www/lks/php/secretary/CsvProtocolGenerator.php` - Основной класс генератора
- `www/lks/php/secretary/generate_csv_protocol.php` - API для скачивания протоколов
- `www/lks/tests/test_csv_protocol_generator.php` - Тесты генератора

### Шаблоны CSV
- `www/lks/files/template/Start_solo.csv` - Шаблон для одиночных дисциплин (K-1, C-1, HD-1, OD-1, OC-1)
- `www/lks/files/template/Start_group.csv` - Шаблон для групповых дисциплин (K-2, C-2, K-4, C-4)
- `www/lks/files/template/Start_dragons.csv` - Шаблон для драконов (D-10) **с дополнительными столбцами**

## Структура шаблонов

### Start_solo.csv (Одиночные дисциплины)
```csv
*Номер протокола*;;*Дисциплина*;;;*Возрастная группа*;;;;
СТАРТ;Время заезда;Вода;-;Номер;ФИО;Год рождения;Группа;Спорт.организация;
;;0;-;;;;;;
;;1;-;;;;;;
;;2;-;;;;;;
;;3;-;;;;;;
;;4;-;;;;;;
;;5;-;;;;;;
;;6;-;;;;;;
;;7;-;;;;;;
;;8;-;;;;;;
;;9;-;;;;;;
;;10;-;;;;;;
```

### Start_group.csv (Групповые дисциплины)
```csv
*Номер протокола*;;*Дисциплина*;;;*Возрастная группа*;;;;
СТАРТ;Время заезда;Вода;-;Номер;ФИО;Год рождения;Группа;Спорт.организация;
;;0;-;;;;;;
;;1;-;;;;;;
;;2;-;;;;;;
;;3;-;;;;;;
;;4;-;;;;;;
;;5;-;;;;;;
;;6;-;;;;;;
;;7;-;;;;;;
;;8;-;;;;;;
;;9;-;;;;;;
;;10;-;;;;;;
```

### Start_dragons.csv (Драконы - D-10)
```csv
*Номер протокола*;;*Дисциплина*;;;*Возрастная группа*;;;;
СТАРТ;Время заезда;Вода;-;Номер;ФИО;Год рождения;Группа;Спорт.организация;Название команды;Город команды;
;;0;-;;;;;;;;;
;;1;-;;;;;;;;;
;;2;-;;;;;;;;;
;;3;-;;;;;;;;;
;;4;-;;;;;;;;;
;;5;-;;;;;;;;;
;;6;-;;;;;;;;;
;;7;-;;;;;;;;;
;;8;-;;;;;;;;;
;;9;-;;;;;;;;;
;;10;-;;;;;;;;;
```

### Плейсхолдеры
- `*Номер протокола*` - заменяется на номер протокола из `protocol_number` (например, "3", "5")
- `*Дисциплина*` - заменяется на название дисциплины (например, "K-1", "D-10")
- `*Возрастная группа*` - заменяется на название возрастной группы (например, "группа 1: 18-29")

### Структура данных участника

#### Для одиночных и групповых дисциплин:
- **Номер** - номер спортсмена (userid)
- **ФИО** - полное имя участника
- **Год рождения** - год рождения участника
- **Группа** - возрастная группа участника
- **Спорт.организация** - город участника

#### Для драконов (D-10):
- **Номер** - номер спортсмена (userid)
- **ФИО** - полное имя участника
- **Год рождения** - год рождения участника
- **Группа** - возрастная группа участника
- **Спорт.организация** - город участника
- **Название команды** - название команды драконов
- **Город команды** - город команды драконов

## Использование

### 1. Скачивание протокола через API

```php
// URL для скачивания протокола
$url = "generate_csv_protocol.php?group_key={groupKey}&mero_id={meroId}&protocol_type=start";

// Пример для одиночной дисциплины
$url = "generate_csv_protocol.php?group_key=1_K-1_M_200_группа 1: 18-29&mero_id=1&protocol_type=start";

// Пример для драконов
$url = "generate_csv_protocol.php?group_key=1_D-10_MIX_1000_Открытый класс: 15-39&mero_id=1&protocol_type=start";
```

### 2. Использование класса CsvProtocolGenerator

```php
require_once 'CsvProtocolGenerator.php';

// Создание генератора
$generator = new CsvProtocolGenerator();

// Определение шаблона для дисциплины
$template = $generator->getTemplateForDiscipline('K-1'); // Возвращает 'Start_solo.csv'
$template = $generator->getTemplateForDiscipline('D-10'); // Возвращает 'Start_dragons.csv'

// Генерация протокола
$csvContent = $generator->generateProtocol($protocolData, $meroData, $template);

// Генерация протокола для конкретной возрастной группы
$csvContent = $generator->generateProtocolForAgeGroup($groupKey);
```

## Поддерживаемые дисциплины

### Одиночные дисциплины (Start_solo.csv)
- K-1 (Байдарка-одиночка)
- C-1 (Каноэ-одиночка)
- HD-1 (Хандель-одиночка)
- OD-1 (Одиночка-одиночка)
- OC-1 (Одиночка-каноэ)

### Групповые дисциплины (Start_group.csv)
- K-2 (Байдарка-двойка)
- C-2 (Каноэ-двойка)
- OD-2 (Одиночка-двойка)
- K-4 (Байдарка-четверка)
- C-4 (Каноэ-четверка)

### Драконы (Start_dragons.csv)
- D-10 (Дракон-десятерка) - **с дополнительными столбцами команды**

## Структура данных JSON

Протоколы хранятся в JSON файлах со следующей структурой:

```json
{
    "discipline": "D-10",
    "sex": "MIX",
    "distance": "1000",
    "ageGroups": [
        {
            "name": "Открытый класс: 15-39",
            "redisKey": "1_D-10_MIX_1000_Открытый класс: 15-39",
            "participants": [
                {
                    "userId": 1001,
                    "fio": "Иванов Иван Иванович",
                    "birthdata": "1995-05-15",
                    "teamCity": "Москва",
                    "teamName": "Спартак Москва",
                    "sportzvanie": "КМС",
                    "lane": 1
                }
            ]
        }
    ]
}
```

## Алгоритм генерации

1. **Загрузка шаблона** - загружается соответствующий CSV шаблон
2. **Замена заголовков** - плейсхолдеры заменяются на реальные данные:
   - `*Номер протокола*` → значение из `protocol_number`
   - `*Дисциплина*` → название дисциплины
   - `*Возрастная группа*` → название возрастной группы
3. **Поиск строк дорожек** - находятся строки с номерами дорожек (0-10)
4. **Заполнение данных участников** - данные участников вставляются в соответствующие строки
5. **Специальная обработка драконов** - для D-10 добавляются столбцы команды
6. **Форматирование** - добавляется BOM для корректного отображения кириллицы

## Особенности

### Кодировка
- Используется UTF-8 с BOM для корректного отображения в Excel
- Поддерживается кириллица

### Номер протокола
- Заменяется из поля `protocol_number` в данных возрастной группы
- Если `protocol_number` отсутствует, используется значение по умолчанию "1"
- Отображается в первой строке CSV файла

### Пустые дорожки
- Дорожки без участников остаются пустыми
- Максимальное количество дорожек: 11 (0-10)

### Формат дат
- Год рождения извлекается из поля `birthdata`
- Формат: YYYY (например, 1995)

### Специальная обработка драконов
- Для дисциплины D-10 используются дополнительные столбцы
- "Название команды" заполняется из `teamName`
- "Город команды" заполняется из `teamCity`
- Все участники одной команды имеют одинаковые данные команды

## Тестирование

### Запуск тестов
```bash
# Тест генератора CSV
php www/lks/tests/test_csv_protocol_generator.php

# Тест драконов
php www/lks/tests/test_dragons_csv.php
```

### Ручное тестирование
1. Создайте мероприятие с дисциплиной D-10
2. Добавьте участников в команды драконов
3. Скачайте CSV протокол
4. Проверьте наличие столбцов "Название команды" и "Город команды"

## Ошибки и отладка

### Логирование
Все ошибки логируются в системный лог с префиксом "=== ОШИБКА ГЕНЕРАЦИИ CSV ПРОТОКОЛА ==="

### Частые ошибки
1. **Шаблон не найден** - проверьте наличие файла шаблона
2. **Группа не найдена** - проверьте корректность group_key
3. **JSON файл не найден** - проверьте наличие файла протоколов
4. **Неправильная структура драконов** - проверьте наличие данных команды

### Отладка
Для отладки используйте тестовый файл или добавьте отладочную информацию:

```php
error_log("Данные протокола: " . json_encode($protocolData));
error_log("Сгенерированный CSV: " . $csvContent);
``` 