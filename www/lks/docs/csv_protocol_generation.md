# Генерация CSV протоколов

## Обзор

Система генерации CSV протоколов позволяет создавать протоколы соревнований в формате CSV, совместимом с Excel и другими программами для работы с таблицами.

## Формат протокола

### Структура CSV файла

Протокол состоит из следующих частей:

1. **Заголовок дисциплины** (строка 1)
   - Номер заезда
   - Название дисциплины и дистанции
   - Пол участников
   - Возрастная группа

2. **Заголовки таблицы** (строка 2)
   - Для стартовых протоколов: СТАРТ, Время заезда, Вода, -, Номер, ФИО, Год рождения, Группа, Спортивный разряд, Спорт.организация
   - Для финишных протоколов: ФИНИШ, Место в заезде, Вода, -, Время прохождения, Минуты, Секунды, Номер, ФИО, Год рождения, Группа, Спортивный разряд, Спорт.организация

3. **Данные участников** (строки 3-12)
   - По одной строке на дорожку (0-9)
   - Пустые строки для дорожек без участников

### Пример стартового протокола

```csv
3;;K-1 200м М;;;группа Ю1: 11-12;;;;
СТАРТ;Время заезда;Вода;-;Номер;ФИО;Год рождения;Группа;Спортивный разряд;Спорт.организация
;;0;-;1754;Сайфудинов Павел Сергеевич;2013;группа Ю1: 11-12;Б/р;Москва
;;1;-;1751;Бутяйкин Макар Сергеевич;2013;группа Ю1: 11-12;Б/р;Москва
;;2;-;1747;Балашов Алексей Иванович;2014;группа Ю1: 11-12;Б/р;Москва
;;3;-;2547;Чорбаджи Даниил Сергеевич;2013;группа Ю1: 11-12;Б/р;Москва
;;4;-;1998;Новиков Иван Александрович;2013;группа Ю1: 11-12;Б/р;Москва
;;5;-;2543;Рубис Даниил Денисович;2014;группа Ю1: 11-12;Б/р;Москва
;;6;-;2540;Горлачук Егор Сергеевич;2013;группа Ю1: 11-12;Б/р;Москва
;;7;-;;;;;;
;;8;-;;;;;;
;;9;-;;;;;;
```

### Пример финишного протокола

```csv
3;;К-1 200м М;;;;;;группа Ю1: 11-12;;;;
ФИНИШ;Место в заезде;Вода;-;Время прохождения;Минуты;Секунды;Номер;ФИО;Год рождения;Группа;Спортивный разряд;Спорт.организация
;1;0;-;00:05.123;0;5.123;1754;Сайфудинов Павел Сергеевич;2013;группа Ю1: 11-12;Б/р;Москва
;2;1;-;00:05.150;0;5.150;1751;Бутяйкин Макар Сергеевич;2013;группа Ю1: 11-12;Б/р;Москва
;3;2;-;00:05.250;0;5.250;1747;Балашов Алексей Иванович;2014;группа Ю1: 11-12;Б/р;Москва
;4;3;-;00:06.133;0;6.133;2547;Чорбаджи Даниил Сергеевич;2013;группа Ю1: 11-12;Б/р;Москва
;5;4;-;00:06.134;0;6.134;1998;Новиков Иван Александрович;2013;группа Ю1: 11-12;Б/р;Москва
;6;5;-;00:06.136;0;6.136;2543;Рубис Даниил Денисович;2014;группа Ю1: 11-12;Б/р;Москва
;7;6;-;00:06.137;0;6.137;2540;Горлачук Егор Сергеевич;2013;группа Ю1: 11-12;Б/р;Москва
;;7;-;;;;;;;;;
;;8;-;;;;;;;;;
;;9;-;;;;;;;;;
```

## API для генерации протоколов

### Endpoint

```
GET /lks/php/secretary/generate_csv_protocol.php
```

### Параметры

- `group_key` (обязательный) - ключ группы протокола в Redis
- `mero_id` (обязательный) - ID мероприятия
- `protocol_type` (опциональный) - тип протокола: 'start' или 'finish' (по умолчанию 'start')

### Пример запроса

```javascript
const url = `/lks/php/secretary/generate_csv_protocol.php?group_key=${encodeURIComponent(groupKey)}&mero_id=${meroId}&protocol_type=${protocolType}`;

const response = await fetch(url, {
    method: 'GET',
    headers: {
        'Content-Type': 'application/json',
    }
});

if (response.ok) {
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `protocol_${groupKey}_${protocolType}.csv`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
}
```

## Структура данных протокола

### Формат данных в Redis

```json
{
    "discipline": "K-1",
    "distance": "200",
    "sex": "М",
    "age_group": "группа Ю1: 11-12",
    "race_number": 3,
    "participants": [
        {
            "userid": "1754",
            "fio": "Сайфудинов Павел Сергеевич",
            "birthdata": "2013-05-15",
            "sportzvanie": "Б/р",
            "city": "Москва",
            "lane": 0
        },
        {
            "userid": "1751",
            "fio": "Бутяйкин Макар Сергеевич",
            "birthdata": "2013-08-22",
            "sportzvanie": "Б/р",
            "city": "Москва",
            "lane": 1
        }
    ]
}
```

### Поля участника

- `userid` - номер спортсмена
- `fio` - ФИО участника
- `birthdata` - дата рождения (формат YYYY-MM-DD)
- `sportzvanie` - спортивное звание
- `city` - город/спортивная организация
- `lane` - номер дорожки (0-9)
- `place` - занятое место (только для финишных протоколов)
- `finish_time` - время финиша в формате "MM:SS.SSS" (только для финишных протоколов)

## Использование в интерфейсе

### Кнопка скачивания протокола

В интерфейсе секретаря на странице протоколов есть кнопки для скачивания:

1. **Скачать стартовые протоколы** - скачивает все стартовые протоколы
2. **Скачать финишные протоколы** - скачивает все заполненные финишные протоколы
3. **Скачать протокол** - скачивает конкретный протокол

### JavaScript функции

```javascript
// Скачивание одного протокола
protocolsManager.downloadProtocol(groupKey, protocolType);

// Массовое скачивание протоколов
protocolsManager.downloadAllProtocols(protocolType);

// Скачивание в формате CSV
protocolsManager.downloadProtocolsInFormat('csv', protocolType);
```

## Особенности реализации

### Кодировка

- Файлы генерируются в кодировке UTF-8 с BOM для корректного отображения кириллицы в Excel
- Разделитель полей: точка с запятой (;)

### Обработка пустых дорожек

- Для дорожек без участников создаются пустые строки
- Максимальное количество дорожек: 10 (0-9)

### Извлечение года рождения

- Из даты рождения извлекается только год
- Поддерживаются форматы: YYYY-MM-DD, YYYY/MM/DD, YYYY.MM.DD

### Обработка времени финиша

- Время финиша разбивается на минуты и секунды с долями
- Формат времени: "MM:SS.SSS" (минуты:секунды.миллисекунды)
- Минуты извлекаются как есть (например, "00" для "00:05.123")
- Секунды извлекаются без ведущего нуля (например, "5.123" для "00:05.123")

### Именование файлов

Файлы именуются по шаблону:
```
protocol_{type}_{event_name}_{timestamp}.csv
```

Где:
- `type` - start или finish
- `event_name` - название мероприятия (до 30 символов)
- `timestamp` - временная метка создания файла

## Тестирование

Для тестирования генерации протоколов используется файл:
```
www/lks/tests/test_csv_protocol_generation.php
```

Запуск теста:
```bash
docker-compose exec php php /var/www/html/lks/tests/test_csv_protocol_generation.php
```

## Файлы системы

- `www/lks/php/secretary/generate_csv_protocol.php` - основной API для генерации протоколов
- `www/lks/php/secretary/csv_protocol_functions.php` - функции генерации CSV
- `www/lks/js/secretary/protocols_new.js` - JavaScript для работы с протоколами
- `www/lks/files/template/EXAMPLE_Start_solo.csv` - пример формата протокола 