<?php
require_once __DIR__ . "/../db/Database.php";
require_once __DIR__ . "/../helpers.php";
require_once __DIR__ . "/age_group_calculator.php";
require_once dirname(__DIR__, 3) . '/vendor/autoload.php';

if (!defined('TEST_MODE') && session_status() === PHP_SESSION_NONE) {
    session_start();
}

// –í —Ä–µ–∂–∏–º–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
if (!defined('TEST_MODE')) {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
    if (!isset($_SESSION['user_role']) || !in_array($_SESSION['user_role'], ['Secretary', 'SuperUser', 'Admin'])) {
        http_response_code(403);
        echo json_encode(['success' => false, 'message' => '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω']);
        exit;
    }
}

// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ POST-–∑–∞–ø—Ä–æ—Å–∞
if (defined('TEST_MODE')) {
    $data = $_POST;
} else {
    $rawInput = file_get_contents('php://input');
    error_log("üîÑ [LOAD_PROTOCOLS_DATA] –°—ã—Ä—ã–µ –≤—Ö–æ–¥—è—â–∏–µ –¥–∞–Ω–Ω—ã–µ: " . $rawInput);
    
    $data = json_decode($rawInput, true);
    
    // –ï—Å–ª–∏ JSON –Ω–µ —Ä–∞—Å–ø–∞—Ä—Å–∏–ª—Å—è, –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ $_POST
    if ($data === null && !empty($_POST)) {
        $data = $_POST;
        error_log("üîÑ [LOAD_PROTOCOLS_DATA] –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ $_POST: " . json_encode($data));
    }
}

// –õ–æ–≥–∏—Ä—É–µ–º –≤—Ö–æ–¥—è—â–∏–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
error_log("üîÑ [LOAD_PROTOCOLS_DATA] –û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –≤—Ö–æ–¥—è—â–∏–µ –¥–∞–Ω–Ω—ã–µ: " . json_encode($data));

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
if (!isset($data['meroId'])) {
    http_response_code(400);
    echo json_encode(['success' => false, 'message' => '–ù–µ —É–∫–∞–∑–∞–Ω ID –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è']);
    exit;
}

try {
    $db = Database::getInstance();
    
    // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏
    $stmt = $db->prepare("SELECT * FROM meros WHERE champn = ?");
    $stmt->execute([$data['meroId']]);
    $mero = $stmt->fetch(PDO::FETCH_ASSOC);
    
    if (!$mero) {
        throw new Exception('–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
    }
    
    // –ü–∞—Ä—Å–∏–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∏—Å—Ü–∏–ø–ª–∏–Ω —Å –≤–æ–∑—Ä–∞—Å—Ç–Ω—ã–º–∏ –≥—Ä—É–ø–ø–∞–º–∏
    $classDistance = json_decode($mero['class_distance'], true);
    if (!$classDistance) {
        throw new Exception('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω –≤ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏');
    }
    
    error_log("üîÑ [LOAD_PROTOCOLS_DATA] –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤ –¥–ª—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è: {$data['meroId']}");
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ protocols_1.json
    $protocolsFile = __DIR__ . "/../../files/json/protocols/protocols_{$data['meroId']}.json";
    
    if (!file_exists($protocolsFile)) {
        // –ï—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ —Å –¥–∞–Ω–Ω—ã–º–∏ –≤—Å–µ—Ö –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        $protocolsData = generateProtocolsFromParticipants($db, $data['meroId'], $classDistance);
        file_put_contents($protocolsFile, json_encode($protocolsData, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE));
        error_log("‚úÖ [LOAD_PROTOCOLS_DATA] –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª protocols_{$data['meroId']}.json");
    } else {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–π–ª
        $content = file_get_contents($protocolsFile);
        $protocolsData = json_decode($content, true);
        error_log("‚úÖ [LOAD_PROTOCOLS_DATA] –ó–∞–≥—Ä—É–∂–µ–Ω —Ñ–∞–π–ª protocols_{$data['meroId']}.json");
    }
    
    if (!$protocolsData) {
        throw new Exception('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤');
    }
    
    echo json_encode([
        'success' => true,
        'message' => '–î–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã',
        'protocols' => $protocolsData,
        'debug' => [
            'totalProtocols' => count($protocolsData),
            'filePath' => $protocolsFile
        ]
    ]);
    
} catch (Exception $e) {
    error_log("–û–®–ò–ë–ö–ê –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤: " . $e->getMessage());
    http_response_code(500);
    echo json_encode([
        'success' => false,
        'message' => $e->getMessage()
    ]);
}

/**
 * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤ –∏–∑ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
 */
function generateProtocolsFromParticipants($db, $meroId, $classDistance) {
    // –ü–æ–ª—É—á–∞–µ–º oid –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
    $stmt = $db->prepare("SELECT oid FROM meros WHERE champn = ?");
    $stmt->execute([$meroId]);
    $meroOid = $stmt->fetchColumn();
    
    if (!$meroOid) {
        throw new Exception('–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
    }
    
    $protocols = [];
    
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—Å–µ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã –∏–∑ class_distance
    foreach ($classDistance as $class => $disciplineData) {
        if (!isset($disciplineData['sex']) || !isset($disciplineData['dist']) || !isset($disciplineData['age_group'])) {
            continue;
        }
        
        $sexes = is_array($disciplineData['sex']) ? $disciplineData['sex'] : [$disciplineData['sex']];
        $distances = is_array($disciplineData['dist']) ? $disciplineData['dist'] : [$disciplineData['dist']];
        $ageGroups = is_array($disciplineData['age_group']) ? $disciplineData['age_group'] : [$disciplineData['age_group']];
        
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é –¥–∏—Å—Ç–∞–Ω—Ü–∏—é
        foreach ($distances as $distanceStr) {
            // –†–∞–∑–±–∏–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É –¥–∏—Å—Ç–∞–Ω—Ü–∏–π –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
            $individualDistances = explode(',', $distanceStr);
            
            foreach ($individualDistances as $distance) {
                $distance = trim($distance);
                
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π –ø–æ–ª
                foreach ($sexes as $sexIndex => $sex) {
                    if (!isset($ageGroups[$sexIndex])) {
                        continue;
                    }
                    
                    $ageGroupString = $ageGroups[$sexIndex];
                    $parsedAgeGroups = AgeGroupCalculator::parseAgeGroups($ageGroupString);
                    
                    if (empty($parsedAgeGroups)) {
                        continue;
                    }
                    
                    // –ü–æ–ª—É—á–∞–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–ª—è –¥–∞–Ω–Ω–æ–π –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã
                    $participants = getParticipantsForDiscipline($db, $meroOid, $class, $sex, $distance);
                    
                    // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Ç–æ–∫–æ–ª –¥–ª—è –∫–∞–∂–¥–æ–π –≤–æ–∑—Ä–∞—Å—Ç–Ω–æ–π –≥—Ä—É–ø–ø—ã
                    foreach ($parsedAgeGroups as $ageGroupIndex => $ageGroup) {
                        $ageGroupName = $ageGroup['full_name'];
                        
                        // –§–∏–ª—å—Ç—Ä—É–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–Ω–æ–π –≥—Ä—É–ø–ø–µ
                        $ageGroupParticipants = [];
                        foreach ($participants as $participant) {
                            $age = AgeGroupCalculator::calculateAgeOnDecember31($participant['birthdata']);
                            if ($age !== null && $age >= $ageGroup['min_age'] && $age <= $ageGroup['max_age']) {
                                $ageGroupParticipants[] = $participant;
                            }
                        }
                        
                        // –ü—Ä–æ–≤–æ–¥–∏–º –∂–µ—Ä–µ–±—å–µ–≤–∫—É
                        $drawnParticipants = conductDrawForProtocol($ageGroupParticipants);
                        
                        // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Ç–æ–∫–æ–ª
                        $protocol = [
                            'meroId' => (int)$meroId,
                            'discipline' => $class,
                            'sex' => $sex,
                            'distance' => $distance,
                            'ageGroups' => [
                                [
                                    'name' => $ageGroupName,
                                    'protocol_number' => $ageGroupIndex + 1,
                                    'participants' => $drawnParticipants,
                                    'redisKey' => "protocol:start:{$meroId}:{$class}:{$sex}:{$distance}:" . str_replace(['(', ')', ' ', ':', '-'], ['', '', '_', '_', '_'], $ageGroupName),
                                    'protected' => false
                                ]
                            ],
                            'created_at' => date('Y-m-d H:i:s')
                        ];
                        
                        $protocols[] = $protocol;
                    }
                }
            }
        }
    }
    
    return $protocols;
}

/**
 * –ü–æ–ª—É—á–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–ª—è –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã
 */
function getParticipantsForDiscipline($db, $meroOid, $class, $sex, $distance) {
    $stmt = $db->prepare("
        SELECT l.*, u.fio, u.birthdata, u.city, u.sportzvanie, u.sex, u.userid, u.country,
               t.teamname, t.teamcity
        FROM listreg l 
        JOIN users u ON l.users_oid = u.oid 
        LEFT JOIN teams t ON l.teams_oid = t.oid
        WHERE l.meros_oid = ? 
        AND l.status IN ('–ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω', '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω')
        AND u.sex = ?
        AND l.discipline::text LIKE ?
    ");
    
    $classDistanceLike = '%"' . $class . '"%';
    $stmt->execute([$meroOid, $sex, $classDistanceLike]);
    
    $allParticipants = $stmt->fetchAll(PDO::FETCH_ASSOC);
    $filteredParticipants = [];
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏
    foreach ($allParticipants as $participant) {
        $classDistanceData = json_decode($participant['discipline'], true);
        
        if (isset($classDistanceData[$class]['dist'])) {
            $distances = is_array($classDistanceData[$class]['dist']) 
                ? $classDistanceData[$class]['dist'] 
                : explode(', ', $classDistanceData[$class]['dist']);
            
            foreach ($distances as $dist) {
                if (trim($dist) == $distance) {
                    $filteredParticipants[] = $participant;
                    break;
                }
            }
        }
    }
    
    return $filteredParticipants;
}

/**
 * –ü—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –∂–µ—Ä–µ–±—å–µ–≤–∫–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
 */
function conductDrawForProtocol($participants) {
    $drawnParticipants = [];
    $lane = 1;
    
    if (empty($participants)) {
        return [];
    }
    
    // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
    shuffle($participants);
    
    foreach ($participants as $participant) {
        $drawnParticipants[] = [
            'userId' => (int)($participant['userid'] ?? 0),
            'fio' => $participant['fio'] ?? '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
            'sex' => $participant['sex'] ?? '',
            'birthdata' => $participant['birthdata'] ?? '',
            'sportzvanie' => $participant['sportzvanie'] ?? '–ë–†',
            'teamName' => $participant['teamname'] ?? '',
            'teamCity' => $participant['teamcity'] ?? '',
            'lane' => $lane++,
            'place' => null,
            'finishTime' => null,
            'addedManually' => false,
            'addedAt' => date('Y-m-d H:i:s')
        ];
    }
    
    return $drawnParticipants;
}
?> 