## Техническое задание (ТЗ) на воспроизведение реализованного проекта KGB‑Pulse

### 1. Назначение и цели системы
Система KGB‑Pulse — веб‑приложение для управления гребными соревнованиями с полным циклом: ведение мероприятий, регистрация участников, формирование команд, расчёт возрастных групп, проведение стартов/финишей, формирование протоколов секретаря, публикация результатов, учёт оплат и автоматизация служебных задач.

Цель ТЗ — описать текущее фактически реализованное поведение так, чтобы система была воссоздана идентично по функционалу, структуре данных и правилам безопасности.

### 2. Технологический стек и инфраструктура
- Backend: PHP 8.2
- БД: PostgreSQL 15
- Кэш/сессии: Redis
- Frontend: HTML5, CSS3, JavaScript, Bootstrap 5, jQuery
- Веб‑сервер: Nginx
- Контейнеризация: Docker + Docker Compose
- Автоматизация: Cron (в отдельном контейнере)

Ограничения:
- Не изменять структуру БД на уровне SQL инициализации. Все изменения логики реализовывать в коде, а не в БД.
- Ничего не устанавливать в систему хоста: запуск через Docker. Разрешены .sh‑скрипты из системы.

### 3. Роли пользователей и права
Иерархия (по `users.userid`):
- Admin: 1–50
- Organizer: 51–150
- Secretary: 151–250
- Sportsman: 1000+
- SuperUser: агрегирует все права (специальная логика в Auth)

Права доступа (ENUM `rights`): `Sportsman`, `Admin`, `Organizer`, `Secretary`, `SuperUser`.

Требования к авторизации:
- Класс `Auth` корректно обрабатывает SuperUser: `hasRole()`, `hasAnyRole()`, `isSuperUser()` возвращают true для всех ролей.
- На каждой странице выполняется проверка ролей и CSRF‑защита для POST.

### 4. База данных: ключевые правила и структура

#### 4.1. Ключевые правила (критично)
- Всегда использовать внутренние ключи `oid` для связей (FK). Внешние идентификаторы (`userid`, `champn`, `teamid`) — для бизнес‑логики и UI.
- Поле `meros.champn` — INTEGER, не строка.
- Поле `users.boats` — массив PostgreSQL (`boats[]`), не JSON.
- Сравнения и TRIM по `meros.status` (ENUM `merostat`) всегда с приведением: `status::text`.

#### 4.2. Таблицы
1) Таблица `users` (пользователи)
- oid SERIAL PK — внутренний ключ
- userid INTEGER UNIQUE — публичный номер спортсмена
- email TEXT UNIQUE
- password TEXT — хранится как хэш (password_hash)
- fio TEXT
- sex VARCHAR(1) — 'М'/'Ж'
- telephone TEXT UNIQUE
- birthdata DATE
- country TEXT, city TEXT
- accessrights rights — по умолчанию 'Sportsman'
- boats boats[] — массив типов лодок (ENUM `boats`)
- sportzvanie sportzvanias — по умолчанию 'БР'

2) Таблица `meros` (мероприятия)
- oid SERIAL PK — внутренний ключ
- champn INTEGER UNIQUE — публичный номер мероприятия
- merodata TEXT — дата/диапазон дат проведения (строка)
- meroname TEXT — название
- class_distance JSONB — описание классов, дистанций, пола и возрастных групп
- defcost NUMERIC(10,2) — базовая стоимость участия
- filepolojenie TEXT, fileprotokol TEXT, fileresults TEXT — пути к файлам
- status merostat — статус мероприятия; сравнения только через `status::text`
- created_by INTEGER — ссылка на `users.oid`

Структура `class_distance` (пример):
```json
{
  "K-1": {
    "sex": ["М", "Ж"],
    "dist": ["200, 500", "500, 1000"],
    "age_group": [
      "группа 1: 18-29, группа 2: 30-39",
      "группа 1: 18-29, группа 2: 30-39"
    ]
  }
}
```

3) Таблица `listreg` (регистрации)
- oid SERIAL PK
- users_oid INTEGER — FK на `users.oid`
- meros_oid INTEGER — FK на `meros.oid`
- teams_oid INTEGER — FK на `teams.oid`
- discipline JSONB — выбранные классы/дистанции участника
- oplata BOOLEAN — оплата подтверждена
- cost NUMERIC(10,2) — стоимость участия
- status statuses — статус регистрации (см. раздел 6)
- role TEXT — роль в команде (по умолчанию 'member')

Пример `discipline`:
```json
{
  "K-1": { "sex": ["М"], "dist": ["200, 500, 1000"] }
}
```

4) Таблица `teams` (команды)
- oid SERIAL PK
- teamid INTEGER UNIQUE — публичный ID команды
- teamname TEXT, team_name TEXT — совместимость
- teamcity TEXT
- persons_amount INTEGER — текущее число участников
- persons_all INTEGER — общее число мест (обычно 14)
- another_team INTEGER — связанная команда
- class TEXT — класс лодки команды

5) Таблица `user_statistic` (статистика пользователей)
- oid SERIAL PK
- meroname TEXT, place TEXT, time TIME, team TEXT, data DATE, race_type TEXT
- users_oid INTEGER — FK на `users.oid`

6) Служебные таблицы
- `notifications` (уведомления): oid, userid (FK на users.oid), type notification_type, title, message, is_read, created_at, email_sent
- `login_attempts`: oid, users_oid, ip, success, attempt_time
- `user_actions`: oid, users_oid, action, ip_address, created_at
- `system_events`: oid, event_type, description, severity, created_at

#### 4.3. ENUM‑типы
- boats: 'D-10', 'K-1', 'K-2', 'K-4', 'C-1', 'C-2', 'C-4', 'HD-1', 'OD-1', 'OD-2', 'OC-1'
- rights: 'Sportsman', 'Admin', 'Organizer', 'Secretary', 'SuperUser'
- statuses: 'В очереди', 'Зарегистрирован', 'Подтверждён', 'Ожидание команды', 'Дисквалифицирован', 'Неявка'
- sportzvanias: 'ЗМС', 'МСМК', 'МССССР', 'МСР', 'МСсуч', 'КМС', '1вр', '2вр', '3вр', 'БР'
- merostat: 'В ожидании', 'Регистрация', 'Регистрация закрыта', 'Перенесено', 'Результаты', 'Завершено'
- notification_type: 'registration', 'participation', 'status_change', 'system'

#### 4.4. Индексы (минимально необходимые)
- users: email, telephone, accessrights
- listreg: status, (опционально) meros_oid, users_oid
- meros: status, created_by
- user_statistic: users_oid, data
- служебные: по полям фильтрации (см. известные индексы в описании проекта)

### 5. Структура веб‑приложения (`/lks/`)
- `/enter/admin/`, `/enter/organizer/`, `/enter/secretary/`, `/enter/user/` — кабинеты по ролям
- Backend API: `/php/common/`, `/php/admin/`, `/php/organizer/`, `/php/secretary/`, `/php/user/`
- Файлы: `/files/` (+ подпапки `excel`, `pdf`, `polojeniya`, `results`, `protocol`, `temp`, `json`, `template`)
- Шаблоны протоколов: `/files/template/Start_dragons.xlsx`, `Finish_dragons.xlsx`, `Start_solo.xlsx`, `Finish_solo.xlsx`, `Start_group.xlsx`, `Finish_group.xlsx`, `technical_results.xlsx`
- JS: `/js/admin`, `/js/organizer`, `/js/secretary`, `/js/user`, общий `main.js`, `registration.js`
- Общие классы: `Auth.php`, `Database.php`, `SessionManager.php`, `RegistrationManager.php`, `EventRegistration.php`, `FileUploadHandler.php`, `helpers.php`

Требование к путям файлов в PHP: использовать `__DIR__`, а не `$_SERVER['DOCUMENT_ROOT']`.

### 6. Бизнес‑логика мероприятий

#### 6.1. Жизненный цикл мероприятия (`meros.status`)
Последовательность:
1) 'В ожидании' → 2) 'Регистрация' → 3) 'Регистрация закрыта' → 4) 'Результаты' → 5) 'Завершено'

Правила:
- Открытие регистрации вручную/по времени.
- Автоматическое закрытие регистрации по расписанию cron.
- Статистики и панели используют сравнения со статусом только через `status::text`.

#### 6.2. Создание/редактирование мероприятия
- Указывает организатор/админ: `meroname`, `merodata`, `champn` (INTEGER), `class_distance` (JSONB), `defcost`, статус, файлы (положение/протокол/результаты), `created_by` (users.oid).
- `class_distance` определяет доступные дисциплины, пол, дистанции, возрастные группы.

#### 6.3. Автоматизация по времени
- `scripts/auto_close_registration.php` — закрывает регистрацию согласно срокам мероприятия.
- `scripts/auto_mark_no_show.php` — отмечает «Неявка» через 30 минут после начала мероприятия (см. раздел 7).

### 7. Регистрация участников и статусы `listreg`

Статусы регистрации (`listreg.status`):
1) "В очереди" — заявка подана, ожидает подтверждения
2) "Ожидание команды" — ожидает формирования экипажа/команды
3) "Подтверждён" — подтверждена организатором
4) "Зарегистрирован" — подтверждена секретарем
5) "Неявка" — участник не явился
6) "Дисквалифицирован" — дисквалификация судьями

Правила кнопок/действий:
- Кнопка «Неявка» доступна для статусов: "В очереди", "Подтверждён", "Ожидание команды".
- Кнопка «Неявка» недоступна для: "Зарегистрирован", "Дисквалифицирован", "Неявка".
- Дисквалификация возможна только для зарегистрированных участников ("Зарегистрирован").
- Автоматическая отметка «Неявка» — через 120 минут после начала мероприятия (cron‑задача).

Хранение выбора участника (`listreg.discipline` JSONB) — по дисциплинам с полом и дистанциями, согласованно с `meros.class_distance`.

Оплата:
- `listreg.cost` — расчёт на основе `defcost` и выбранных дисциплин (конкретная формула — как реализовано сейчас);
- `listreg.oplata` — булево подтверждение оплаты.

Команды:
- Согласовывать `teams_oid`, учитывать `persons_amount` и `persons_all`, связанные команды `another_team` и класс лодки `teams.class`.

### 8. Расчёт возрастных групп

Источник правил — `meros.class_distance.age_group`:
- По каждой дисциплине (например, `K-1`, `C-1`, `D-10`) и полу определяется массив возрастных групп.
- Индексация возрастных строк соответствует индексу пола в `sex[]`.

Алгоритм для одиночных лодок:
1) Определить пол участника и дисциплину.
2) Найти индекс пола в `class_distance[class].sex`.
3) Взять строку `age_group[sexIndex]` и разбить по ", " на группы.
4) Для каждой группы: разделить по ": " на [название, диапазон], диапазон по "-" на [min, max].
5) Возраст участника считать на дату 31.12 текущего года. Попадание в [min, max] — это его группа.
6) Использовать полное имя группы как значение: например, "группа 1: 18-29".

Групповые лодки (K-2, K-4, C-2, C-4):
- Использовать средний возраст всех членов экипажа, затем применить алгоритм как выше.

D-10 (драконы):
- Использовать минимальный возраст члена экипажа с ролью "гребец", затем применить алогитм как выше. Рулевой, барабанщик и запасные гребцы в подсчете возраста не участвуют

Ограничение: протоколы и распределение по группам осуществляются только по реально существующим группам из `age_group` для соответствующей комбинации дисциплина/пол/дистанция. Если подходящая группа не найдена — участник в группу не попадает.

### 9. Рабочее место секретаря и протоколы

Назначение: формирование стартовых, финишных протоколов и технических результатов по дисциплинам, полу, дистанциям и возрастным группам.

Шаблоны:
- Используются Excel‑шаблоны из `/lks/files/template/`:
  - `Start_dragons.xlsx`, `Finish_dragons.xlsx`
  - `Start_solo.xlsx`, `Finish_solo.xlsx`
  - `Start_group.xlsx`, `Finish_group.xlsx`
  - `technical_results.xlsx`

Создание протоколов:
- Источник данных — `listreg` (выбранные дисциплины/дистанции, статус, команда), `users` (ФИО, пол, дата рождения), `teams` (название, город), `meros` (классы/дистанции/группы).
- Фильтрация: по мероприятию, дисциплине, полу, дистанции, возрастной группе. Использовать только группы, реально заданные в `class_distance`.
- Кэширование промежуточных протоколов в Redis (`protocol:*`) с настраиваемым TTL.
- Экспорт/сохранение в `/lks/files/protocol/`.

Операции секретаря:
- Формирование стартовых списков с учётом статусов и допусков.
- Учёт неявок и дисквалификаций по правилам раздела 7.
- Внесение результатов и вычисление мест в финишных протоколах.
- Публикация технических результатов (сводных), сохранение копий в файловой системе и ссылок в `meros`.

Требования к корректности:
- Не формировать протоколы для несуществующих комбинаций дисциплина/пол/дистанция/возрастная группа.
- Все сравнения по статусам мероприятий через `status::text`.

### 10. Redis: сессии, кэш и протоколы
- Сессии: ключи `session:*`, TTL 96 часов.
- Протоколы: `protocol:*`, TTL настраивается по мероприятию.
- Кэш ответов/данных: `cache:*`, TTL 1 час.

### 11. Автоматизация и расписание
- Ежечасно: автозакрытие регистрации (`auto_close_registration.php`), автоотметка неявки (`auto_mark_no_show.php`).
- Ежедневно: резервное копирование БД (2:00), Redis (3:00), очистка данных (5:00).
- Еженедельно: очистка логов (воскресенье, 4:00).

### 12. Безопасность и защита от кибератак

Аутентификация и сессии:
- Хеширование паролей `password_hash`/`password_verify`.
- Защита от перебора: лимит попыток входа с логированием в `login_attempts` и временными блокировками с таймером по формуле 1 минута * (2^(количество блокировок-1)).
- Защита сессий: `HttpOnly`, `Secure` (в проде через HTTPS), защита от фиксации сессии, срок жизни и принудительный ре‑логин при критических действиях.
- Сессии в Redis с контролем TTL (96ч) и принудительным logout при отзыве прав.

Авторизация и контроль доступа:
- Строгая проверка ролей на каждой странице/эндпоинте. SuperUser имеет все права.
- Принцип наименьших привилегий для административных операций.

Защита данных и инъекций:
- Везде использовать Prepared Statements для SQL.
- Запрещены конкатенации пользовательского ввода в SQL.
- Для ENUM `meros.status` — только сравнения через `status::text`.

Валидация и санитизация:
- Серверная валидация всех входных данных, типобезопасность (champn — INTEGER, boats — PostgreSQL array).
- Санитизация строк для вывода (XSS), escaping HTML.
- Защита от загрузки вредоносных файлов: проверка MIME/расширений, ограничения размера, сохранение только в разрешённые каталоги.

CSRF и запросы:
- CSRF‑токены для всех небезопасных POST‑операций, привязка к сессии и сроку действия.
- CORS — по умолчанию закрыт, только доверенные источники.

Файловая безопасность:
- Исключить directory traversal, нормализовать пути, использовать `__DIR__`.
- Запрет на выполнение загруженных файлов, хранение вне web‑root при необходимости, раздача статикой через Nginx с безопасными правилами.

Транспорт и секреты:
- Трафик только по HTTPS (TLS). HSTS включён на уровне Nginx.
- Секреты (`DB_PASSWORD`, `SMTP_PASSWORD`, `JWT_SECRET`, `CSRF_SECRET`) — только в `.env`, без логирования и без попадания в репозиторий.

Логирование и аудит:
- Логирование ошибок и подозрительной активности (PHP error/slow, Nginx access/error, PostgreSQL запросы/ошибки).
- Аудит действий пользователей в `user_actions` с IP и временем.

Прочее:
- Ограничение нагрузки и rate‑limiting на критичных эндпоинтах.
- Проверка входящих файлов/данных на соответствие шаблонам (протоколы).
- Регулярные бэкапы и проверка восстановления.

### 13. Нефункциональные требования
- Производительность: использовать индексы, кэш Redis, избегать N+1 запросов.
- Масштабирование: контейнеризация, независимые сервисы (web, php-fpm, db, redis, cron).
- Отказоустойчивость: корректная обработка ошибок, таймауты, повторные попытки там, где уместно.
- Конкурентность: атомарные изменения статусов/оплат, транзакции для критичных операций.
- Локализация: русский и английский интерфейс и статусы.

### 14. Развёртывание и эксплуатация
- Управление через Docker Compose:
  - Запуск: `docker-compose up -d`
  - Остановка: `docker-compose down`
  - Логи: `docker-compose logs -f`
  - Пересборка: `docker-compose up -d --build`
- Переменные окружения (.env): `DB_PASSWORD`, `SMTP_PASSWORD`, `JWT_SECRET`, `CSRF_SECRET` и др.
- Данные БД и Redis — в персистентных томах.
- Не устанавливать системные пакеты на хосте. PHP — только в контейнере.

### 15. Тестирование и контроль качества
- Тестовые файлы — в `/lks/tests/`.
- Наличие тестов: `test_class_distance_structure.php`, `test_superuser_access.php` и др.
- Тесты и сборки запускать внутри Docker. Проверять, что не нарушены правила ENUM и сравнения `status::text`.

### 16. Мониторинг и логирование
- Системные логи: Nginx (access/error), PHP (error/slow), PostgreSQL (запросы/ошибки).
- Приложение: безопасность (попытки входа, подозрительная активность), производительность, использование ресурсов, вывод SuperUser уведомлений безопасности.
- Скрипты поддержки: `monitor_system.php`, `security_check.php`.

### 17. Критические требования соответствия
- Не изменять БД инициализации (`01_init.sql`, структура считается эталонной).
- Всегда использовать `oid` для внешних ключей.
- `champn` — INTEGER; `boats` — PostgreSQL array; никакого JSON вместо массивов.
- Все сравнения со статусом мероприятия — только через `status::text`.

### 18. Приложения

Пример `class_distance`:
```json
{
  "K-1": {
    "sex": ["М", "Ж"],
    "dist": ["200, 500", "500, 1000"],
    "age_group": [
      "группа 1: 18-29, группа 2: 30-39",
      "группа 1: 18-29, группа 2: 30-39"
    ]
  },
  "D-10": {
    "sex": ["M", "W", "MIX"],
    "dist": ["200, 500, 1000", "200, 500, 1000", "200, 500, 1000"],
    "age_group": [
      "группа 1: 18-29, группа 2: 30-39",
      "группа 1: 18-29, группа 2: 30-39",
      "группа 1: 18-29, группа 2: 30-39"
    ]
  }
}
```

Пример `discipline` участника:
```json
{
  "K-1": { "sex": ["М"], "dist": ["200, 500"] },
  "C-1": { "sex": ["Ж"], "dist": ["500"] }
}
```

Примечание: протоколы создаются только по реально существующим в `class_distance` группам, для которых заданы дисциплина/пол/дистанции/возрастные диапазоны.


### 19. Роли: меню и функциональность

Общие принципы:
- Доступ к страницам и действиям определяется ролью. Проверка выполняется сервером на каждой странице/эндпоинте.
- Все изменения данных — через защищённые POST‑запросы с CSRF‑токенами, валидацией и Prepared Statements.
- SuperUser имеет доступ ко всем пунктам меню всех ролей и видит уведомления безопасности.

#### 19.1. Администратор (`/lks/enter/admin/`)

Меню и страницы:
- Главная: `index.php`
  - Сводка по системе: пользователи, мероприятия, последние действия.
  - Быстрые ссылки на ключевые разделы.
- Пользователи: `users.php`
  - Просмотр, поиск и фильтрация пользователей.
  - Создание/редактирование пользователя: ФИО, email, телефон, дата рождения, пол, права доступа (`accessrights`), спортивное звание, лодки (`boats[]`).
  - Сброс пароля, блокировка/разблокировка аккаунта.
  - Просмотр истории действий пользователя (сводка).
- Данные: `data.php`
  - Импорт/экспорт служебных данных (CSV/JSON) в каталоги `/data/` и `/lks/files/`.
  - Запуск сервисных задач: резервное копирование, очистка временных данных (через соответствующие скрипты/контейнеры).
- Мероприятия: `events.php`
  - Полный CRUD мероприятий (`meros`): `meroname`, `merodata`, `champn` (INTEGER), `class_distance` (JSONB), `defcost`, файлы (`filepolojenie`, `fileprotokol`, `fileresults`), `status` (`status::text` при сравнениях).
  - Управление доступными комбинациями дисциплин/пола/дистанций/возрастных групп в `class_distance`.
  - Перевод статуса мероприятия по жизненному циклу.
- Лодки: `boats.php`
  - Управление отображением/доступностью лодок на уровне интерфейса, добавение и удаление новых классов лодок (с изменением ENUM в БД).
  - Справочная информация по типам лодок и соответствию дисциплинам.
- Статистика: `statistics.php`
  - Сводные метрики по пользователям, мероприятиям, регистрациям, оплатам.
  - Выгрузки отчётов в `/lks/files/`.

Функциональность администратора:
- Полный доступ ко всем мероприятиям и регистрациям.
- Назначение ролей пользователям, административные операции, аудит действий.

#### 19.2. Организатор (`/lks/enter/organizer/`)

Меню и страницы:
- Главная: `index.php`
  - Сводка по мероприятиям организатора (`meros.created_by = users.oid`).
  - Быстрые действия: создать мероприятие, открыть/закрыть регистрацию.
- Календарь: `calendar.php`
  - Календарный просмотр мероприятий, фильтры по статусам.
  - Переход к редактированию мероприятия.
- Создать мероприятие: `create-event.php`
  - Создание `meros`: заполнение полей, загрузка файла положения, задание `class_distance`. Возможность создать мероприятие из файла через зугрузку в формате xlsx
  - Первичный статус: 'В ожидании' или 'Регистрация'.
  - Создание через сайт — пошагово:
    - Поля формы: `meroname` (обязательно), `champn` (INTEGER, обязательно, уникально), `merodata` (обязательно), `defcost` (>=0), `status` (одно из `merostat`), файл положения (`filepolojenie`, необязательно), `class_distance` (обязательно, валидный JSON по схеме ниже).
    - Загрузка файла положения: проверка расширений/типов (например, PDF/DOCX), ограничение размера, сохранение в `/lks/files/polojeniya/` с уникальным именем, путь пишется в `meros.filepolojenie`. Пути формируются на сервере, использовать `__DIR__`.
    - Конструктор `class_distance`: интерфейс позволяет добавить дисциплины (например, `K-1`, `C-1`, `D-10`), для каждой — массив `sex`, строки дистанций `dist` по каждому полу и строки возрастных групп `age_group` по каждому полу. Индексация `age_group[i]` соответствует `sex[i]`. Формат группы: "группа N: min-max"; группы объединяются через ", ".
    - Валидация: `champn` — целое число и уникально; `class_distance` — не пустой, содержит синхронизированные массивы `sex`/`dist`/`age_group`; все диапазоны возраста корректны (min ≤ max). Сравнения статусов мероприятия — через `status::text` только на чтение.
    - Импорт из XLSX: загрузка файла с шаблоном, сервер парсит и предлагает предпросмотр: дисциплины, `sex`, `dist`, `age_group`; при подтверждении формирует `class_distance`. Неверные/пропущенные поля подсвечиваются, создание блокируется до исправления.

  - Импорт из XLSX — формат и валидация:
    - Формат файла:
      - Ожидается один лист: `Classes` (также допустимо `Классы`). Первая строка — заголовки столбцов.
      - Обязательные столбцы:
        - `class` — строка, название дисциплины/класса лодки (пример: `K-1`, `C-1`, `D-10`).
        - `sex` — одно из: для одиночных/групповых лодок `М` или `Ж`; для `D-10` — `M`, `W`, `MIX`.
        - `dist` — строка со списком дистанций в метрах, разделённых запятыми (пример: `200, 500, 1000`).
        - `age_group` — строка со списком групп через запятую, каждая группа в формате `группа N: min-max` (пример: `группа 1: 18-29, группа 2: 30-39`).
      - Повторяющиеся строки по одному и тому же `class` допускаются для разных значений `sex`. Порядок строк определяет порядок в массивах `sex`, `dist`, `age_group`.
    - Пример строк:
      - `class=K-1; sex=М; dist=200, 500; age_group=группа 1: 18-29, группа 2: 30-39`
      - `class=K-1; sex=Ж; dist=200; age_group=группа 1: 18-29`
      - `class=D-10; sex=MIX; dist=200, 500, 1000; age_group=группа 1: 18-29, группа 2: 30-39`
    - Валидация значений:
      - `class`: непустая строка; допустимы буквы/цифры/`-`/`_` (регистронезависимо). Новые классы разрешены на уровне JSON (не влияют на ENUM БД).
      - `sex`: только допустимые значения. Для `D-10` — `M`/`W`/`MIX`; для прочих — `М`/`Ж`.
      - `dist`: парсинг в массив целых чисел > 0; разделители — запятые, допускаются пробелы; дубликаты удаляются; итоговая строка нормализуется вида `200, 500, 1000`.
      - `age_group`: каждая подстрока должна соответствовать `^группа \d+: \d+-\d+$`; `min` и `max` — целые, `0 ≤ min ≤ max ≤ 120`.
      - Согласованность: количество элементов `dist` и `age_group` не обязано совпадать, но `age_group` обязательно присутствует для каждого `sex`. Для одного `class` набор `sex` не должен повторяться.
    - Нормализация и ошибки:
      - Приведение пробелов/регистр, удаление невидимых символов.
      - Сообщения об ошибках указывают лист, строку и столбец (например, `Classes!B7: недопустимое значение sex`).
      - При наличии ошибок предпросмотр отображает проблемные поля и запрещает продолжение.
    - Автоподстановка в форму:
      - После успешного парсинга в форме динамически создаются блоки по каждому значению `class`.
      - В каждом блоке для каждой строки `sex` создаются:
        - селектор/поле `Пол` со значением из файла (`М`/`Ж`/`M`/`W`/`MIX`),
        - текстовое поле `Дистанции` с нормализованной строкой (пример: `200, 500, 1000`),
        - текстовое поле `Возрастные группы` с нормализованной строкой (пример: `группа 1: 18-29, группа 2: 30-39`).
      - Пользователь может вручную отредактировать любые автоподставленные поля перед сохранением; повторная валидация выполняется на клиенте и сервере.
    - Формирование `class_distance`:
      - Перед отправкой формы данные из блоков собираются в JSON вида:
        ```json
        {
          "K-1": {
            "sex": ["М", "Ж"],
            "dist": ["200, 500", "200"],
            "age_group": [
              "группа 1: 18-29, группа 2: 30-39",
              "группа 1: 18-29"
            ]
          },
          "D-10": {
            "sex": ["MIX"],
            "dist": ["200, 500, 1000"],
            "age_group": ["группа 1: 18-29, группа 2: 30-39"]
          }
        }
        ```
      - Итоговый JSON валидируется на сервере перед записью в `meros.class_distance`.

  - Импорт из текстового файла с разделителями (точно как реализовано сейчас):
    - Формат файла (UTF-8, 4 строки, каждая с ключом и значениями):
      - `classes = K-1; C-1;`
      - `sex = М, Ж; М, Ж;`
      - `distance = 200, 500 | 200, 500; 2000, 5000 | 2000, 5000;`
      - `age_group = группа 1: 18-29, группа 2: 30-39 | группа 1: 18-29, группа 2: 30-39; группа 1: 18-29, группа 2: 30-39 | группа 1: 18-29, группа 2: 30-39;`
    - Правила парсинга:
      1) Для каждой строки взять подстроку после `=` и разбить по `;` на элементы. Триммировать пробелы у каждого элемента. Пустые элементы в конце (из-за завершающей `;`) отбрасывать.
      2) Должно получиться одинаковое количество элементов во всех четырёх массивах. Индекс `i` задаёт одну запись: `class[i]`, `sex[i]`, `distance[i]`, `age_group[i]`.
      3) `sex[i]` дополнительно разбить по `,` на массив полов для данной записи. Пробелы отрезать. Допустимые значения: одиночные/групповые лодки — `М`, `Ж`; для D-10 — `M`, `W`, `MIX`.
      4) `distance[i]` разбить по `|` на массив строк по полу (порядок совпадает с порядком полов из п.3). Каждую строку дистанций нормализовать: разбить по `,`, преобразовать в целые числа > 0, удалить дубликаты, собрать в строку через `", "` (пример: `200, 500, 1000`).
      5) `age_group[i]` разбить по `|` на массив строк по полу (индексы соответствуют п.3). Каждую строку групп нормализовать: группы разделены запятыми, каждая группа формата `группа N: min-max`, где `0 ≤ min ≤ max ≤ 120`. Пробелы привести к единообразию.
      6) Валидация соответствия: количество сегментов, полученных в п.4 и п.5 (разделитель `|`), должно равняться количеству полов из п.3. Иначе — ошибка импорта с указанием индекса `i` и поля.
    - Построение структуры `class_distance` по индексу `i`:
      - `sex` — массив полов из п.3, в исходном порядке.
      - `dist` — массив нормализованных строк дистанций по каждому полу (из п.4), индексы соответствуют `sex`.
      - `age_group` — массив нормализованных строк возрастных групп по каждому полу (из п.5), индексы соответствуют `sex`.
    - Пример (с учётом описанного входа):
      - Индекс 0: `class=K-1; sex=М, Ж; dist=200, 500 | 200, 500; age_group=группа 1: 18-29, группа 2: 30-39 | группа 1: 18-29, группа 2: 30-39`
      - Индекс 1: `class=C-1; sex=М, Ж; dist=2000, 5000 | 2000, 5000; age_group=группа 1: 18-29, группа 2: 30-39 | группа 1: 18-29, группа 2: 30-39`
    - Результирующий фрагмент `class_distance`:
      ```json
      {
        "K-1": {
          "sex": ["М", "Ж"],
          "dist": ["200, 500", "200, 500"],
          "age_group": [
            "группа 1: 18-29, группа 2: 30-39",
            "группа 1: 18-29, группа 2: 30-39"
          ]
        },
        "C-1": {
          "sex": ["М", "Ж"],
          "dist": ["2000, 5000", "2000, 5000"],
          "age_group": [
            "группа 1: 18-29, группа 2: 30-39",
            "группа 1: 18-29, группа 2: 30-39"
          ]
        }
      }
      ```
    - Автоподстановка в форму: после успешного разбора файл заполняет те же динамические поля, что и импорт из XLSX (блоки по каждому `class`, внутри — по каждому `sex` поля `Дистанции` и `Возрастные группы`). Пользователь может править значения перед сохранением, с повторной валидацией на клиенте и сервере.
    - Привязка автора: `created_by` = `users.oid` текущего пользователя (организатор).
    - Обработка ошибок: серверные сообщения об обязательных полях, конфликте `champn`, неверной структуре `class_distance`, недопустимом файле положения.
    - Результат: при успехе — сохранение записи в `meros` и редирект на `events.php` с уведомлением; статус устанавливается согласно выбору ('В ожидании' или 'Регистрация').
- Мероприятия: `events.php`
  - Список мероприятий с фильтрами.
  - Редактирование карточки мероприятия, перевод статуса, обновление файлов.
- Очередь регистраций: `queue.php`
  - Заявки со статусом "В очереди"/"Ожидание команды": подтверждение, отклонение, перевод в "Подтверждён", подтверждение оплаты без ее отмены.
  - Контроль комплектования команд.
- Регистрации: `registrations.php`
  - Поиск/фильтрация регистраций по пользователю, статусу, дисциплине.
  - Массовые операции: подтверждение, изменение стоимости, экспорт.
- Редактирование регистрации: `edit-registration.php`
  - Изменение `discipline` (JSONB) в рамках доступных правил `class_distance`.
  - Изменение статуса: "В очереди" → "Ожидание команды" → "Подтверждён".
  - Установка стоимости `cost`.
- Редактирование команды: `edit-team.php`
  - Привязка регистраций к команде (`teams_oid`), контроль `persons_amount`/`persons_all`.
  - Учёт связанной команды (`another_team`) и класса лодки.

Функциональность организатора:
- Управление только своими мероприятиями, регистрациями и командами.
- Подтверждение оплат через соответствующий backend‑эндпоинт (`/php/organizer/confirm_payment.php`).

#### 19.3. Секретарь (`/lks/enter/secretary/`)

Меню и страницы:
- Главная: `index.php`
  - Сводка по текущим мероприятиям в статусах 'Регистрация закрыта'/'Результаты'.
  - Быстрые ссылки на раздел «Проведение мероприятий».
- Мероприятия: `events.php`
  - Список мероприятий доступных к проведению и формированию протоколов.
  - Переход к режиму проведения.
- Проведение мероприятий: `main.php`
  - Основной рабочий экран проведения: стартовые списки, статусы участников, отметки "Неявка" (по правилам раздела 7).
  - Фиксация фактов дисциплинарных решений (дисквалификация только для "Зарегистрирован").
- Протоколы: `protocols.php`
  - Формирование стартовых/финишных протоколов и технических результатов.
  - Фильтры: мероприятие, дисциплина, пол, дистанция, возрастная группа.
  - Экспорт/сохранение только в `/lks/files/protocol/` и кэш `protocol:*` (Redis).
- Результаты: `results.php`
  - Ввод времени/результатов, вычисление мест, сохранение в файлы и публикация ссылок в `meros`.

Функциональность секретаря:
- Оперативное проведение соревнований, работа со статусами регистраций по правилам раздела 7.
- Генерация и публикация протоколов, соблюдение ограничений по группам из `class_distance`.

#### 19.4. Спортсмен (`/lks/enter/user/`)

Меню и страницы:
- Главная: `index.php`
  - Личные уведомления, ближайшие мероприятия, краткая статистика.
- Календарь: `calendar.php`
  - Просмотр календаря мероприятий, фильтрация и переход к странице мероприятия.
- Статистика: `statistics.php`
  - Просмотр личной статистики из `user_statistic` (места, время, команды, даты, тип гонки).
- Профиль (общий раздел): `/lks/enter/common/profile.php`
  - Редактирование контактных данных, лодок (`boats[]`), согласий и уведомлений.

Функциональность спортсмена:
- Регистрация на мероприятия через соответствующие формы (выбор дисциплин/дистанций согласно `class_distance`).
- Просмотр статусов своих заявок и результатов.

#### 19.5. SuperUser
- Доступен весь функционал всех ролей.
- Дополнительно: просмотр уведомлений безопасности и системных журналов в административных разделах.

