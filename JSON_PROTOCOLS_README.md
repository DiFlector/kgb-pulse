# Система JSON протоколов для KGB-Pulse

## Обзор изменений

Система полностью переведена с Redis на JSON файлы для хранения протоколов соревнований.

## Архитектура новой системы

### 1. Менеджер JSON протоколов
- **Файл**: `www/lks/php/common/JsonProtocolManager.php`
- **Назначение**: Центральный класс для работы с JSON файлами протоколов
- **Основные методы**:
  - `saveProtocol()` - сохранение протокола
  - `loadProtocol()` - загрузка протокола
  - `updateProtocol()` - обновление протокола с сохранением защищенных данных
  - `protocolExists()` - проверка существования протокола
  - `hasProtectedData()` - проверка защищенных данных

### 2. Структура файлов протоколов
```
www/lks/files/json/protocols/
├── protocol_1_K-1_М_200_группа_1.json
├── protocol_1_K-1_Ж_200_группа_1.json
├── protocol_1_C-1_М_500_группа_1.json
└── ...
```

### 3. Формат JSON файла протокола
```json
{
  "data": {
    "name": "группа 1",
    "protocol_number": 1,
    "participants": [
      {
        "userId": 1001,
        "fio": "Иванов Иван",
        "lane": 1,
        "water": 1,
        "place": null,
        "finishTime": null,
        "protected": false
      }
    ],
    "redisKey": "protocol:1:K-1:М:200:группа 1"
  },
  "protected": false,
  "created_at": "2024-01-15 10:30:00",
  "updated_at": "2024-01-15 10:30:00",
  "redisKey": "protocol:1:K-1:М:200:группа 1"
}
```

## Логика работы системы

### 1. Открытие страницы с таблицами
```
Файл есть? → Грузим данные из JSON
Файла нет? → Жеребьевка (создание новых протоколов)
```

### 2. Жеребьевка
```
Файл есть и нажали жеребьевку? → Проверяем защищенные данные
- Есть защищенные данные → Сохраняем их, остальное перерандомим
- Нет защищенных данных → Полная жеребьевка
```

### 3. Новые участники
```
Новые участники → Добавляются в БД и файл
При обновлении → Данные не теряются
```

## API endpoints

### 1. Загрузка протоколов
- **URL**: `/lks/php/secretary/load_protocols_data.php`
- **Метод**: POST
- **Данные**: `{meroId: 1, disciplines: [...]}`

### 2. Получение протоколов
- **URL**: `/lks/php/secretary/get_protocols_data.php`
- **Метод**: POST
- **Данные**: `{meroId: 1, disciplines: [...]}`

### 3. Жеребьевка
- **URL**: `/lks/php/secretary/conduct_draw_json.php`
- **Метод**: POST
- **Данные**: `{groupKey: "protocol:1:K-1:М:200:группа 1", discipline: "K-1", preserveProtected: true}`

### 4. Удаление участника
- **URL**: `/lks/php/secretary/remove_participant.php`
- **Метод**: POST
- **Данные**: `{groupKey: "...", userId: 1001}`

### 5. Обновление дорожки
- **URL**: `/lks/php/secretary/update_lane.php`
- **Метод**: POST
- **Данные**: `{groupKey: "...", userId: 1001, lane: 3}`

## Защищенные данные

### Что сохраняется при жеребьевке:
- **Дороги** (`lane`, `water`) - если уже назначены
- **Места** (`place`) - если уже заняты
- **Время финиша** (`finishTime`) - если уже записано

### Логика защиты:
1. Участник с `protected: true` сохраняет свои данные
2. Участник с `protected: false` получает новую дорожку
3. Новые участники всегда получают новые дорожки

## Удаленные компоненты

### 1. Redis контейнер
- Удален из `docker-compose.yaml`
- Удалены переменные окружения Redis
- Удалены зависимости Redis из `composer.json`

### 2. Redis расширение PHP
- Удалено из `images/php/Dockerfile`
- Удален `RedisManager.php`

### 3. Старые API файлы
- `conduct_draw_api.php` - заменен на `conduct_draw_json.php`
- Старые версии файлов протоколов

## Преимущества новой системы

### 1. Простота
- Нет зависимости от Redis
- Файлы легко читать и отлаживать
- Простая структура данных

### 2. Надежность
- Данные сохраняются на диске
- Нет риска потери данных при перезапуске
- Легкое резервное копирование

### 3. Производительность
- Быстрое чтение JSON файлов
- Нет сетевых задержек Redis
- Кэширование на уровне файловой системы

### 4. Отладка
- Легко просматривать содержимое файлов
- Простая диагностика проблем
- Возможность ручного редактирования

## Миграция данных

### Автоматическая миграция:
1. При первом обращении к протоколам система создает JSON файлы
2. Старые данные Redis игнорируются
3. Новые данные сохраняются только в JSON

### Ручная миграция (если нужно):
```bash
# Остановить систему
docker-compose down

# Удалить Redis данные
rm -rf data/redis/

# Запустить систему
docker-compose up -d
```

## Очистка данных

### Автоматическая очистка:
- Старые протоколы (старше 7 дней) удаляются автоматически
- Временные файлы (старше 24 часов) удаляются автоматически
- Логи (старше 7 дней) удаляются автоматически

### Ручная очистка:
```bash
# Очистить все протоколы
rm -rf www/lks/files/json/protocols/*

# Очистить временные файлы
rm -rf www/lks/files/temp/*

# Очистить логи
rm -rf logs/*.log
```

## Мониторинг

### Логи системы:
- `logs/cleanup.log` - логи очистки данных
- `logs/php/error.log` - ошибки PHP
- `logs/nginx/access.log` - логи доступа

### Проверка состояния:
```bash
# Проверить количество протоколов
ls -la www/lks/files/json/protocols/ | wc -l

# Проверить размер файлов
du -sh www/lks/files/json/protocols/

# Проверить последние изменения
ls -lat www/lks/files/json/protocols/ | head -10
```

## Тестирование

### Проверка работы системы:
1. Откройте страницу секретаря
2. Выберите мероприятие
3. Проверьте загрузку протоколов
4. Проведите жеребьевку
5. Проверьте сохранение данных

### Проверка файлов:
```bash
# Посмотреть содержимое протокола
cat www/lks/files/json/protocols/protocol_1_K-1_М_200_группа_1.json | jq '.'

# Проверить структуру
jq '.data.participants | length' www/lks/files/json/protocols/protocol_1_K-1_М_200_группа_1.json
```

## Резервное копирование

### Автоматическое:
```bash
# Копирование протоколов
cp -r www/lks/files/json/protocols/ backup/protocols_$(date +%Y%m%d)/

# Сжатие
tar -czf backup/protocols_$(date +%Y%m%d).tar.gz backup/protocols_$(date +%Y%m%d)/
```

### Восстановление:
```bash
# Распаковка
tar -xzf backup/protocols_20240115.tar.gz

# Восстановление
cp -r backup/protocols_20240115/* www/lks/files/json/protocols/
``` 