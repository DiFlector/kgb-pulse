# Техническое задание: Система управления спортивными мероприятиями KGB-Pulse

## 1. Общее описание проекта

Система KGB-Pulse предназначена для комплексного управления спортивными мероприятиями по гребле на байдарках и каноэ, включая регистрацию участников, формирование команд, проведение соревнований и обработку результатов.

**Веб-интерфейс**: Начальная страница сайта http://localhost/lks/index.php (или http://pulse_rowing_base.ru/lks/index.php)

## 2. Архитектура системы

### 2.1 Технический стек
- **Backend**: PHP 8.2+, PostgreSQL 15, Redis
- **Frontend**: HTML5, CSS3, Bootstrap 5, jQuery
- **Инфраструктура**: Docker, Nginx, Cron
- **Email**: PHPMailer с SMTP (Yandex)

### 2.2 Структура контейнеров Docker

**Контейнеры системы:**
- **pulse-nginx-1**: Nginx web-сервер (порт 80/443)
- **pulse-php-1**: PHP-FPM 8.2
- **pulse-postgres-1**: PostgreSQL 15 (база данных: `pulse_rowing_db`)
- **pulse-redis-1**: Redis для кэширования и хранения протоколов
- **pulse-cron-1**: Автоматические задачи (cron)

**Основная база данных:**
- **Название**: `pulse_rowing_db` (не `kgb_pulse_db`)
- **Пользователь**: `pulse_user`
- **Хост**: `postgres` (внутри Docker сети)

**Redis структура:**
- **Протоколы**: `protocols:*` - хранение данных о протоколах соревнований
- **Сессии**: `sessions:*` - пользовательские сессии
- **Кэш**: `cache:*` - кэширование запросов к БД

## 3. Роли пользователей и права доступа

### 3.1 SuperUser (userid: 999)
- **Полный доступ ко всем функциям системы**
- Создание и удаление мероприятий
- Управление всеми пользователями
- Доступ к административным функциям
- Системные настройки и мониторингv
- Управление профилем

### 3.2 Admin (userid: 1-50)
- Панель управления (Состояние системы, быстрые действия)
- Управление пользователями (создание, редактирование, смена ролей, изменение userid, поиск по email, фио и ролям)
- Полный доступ к регистрациям участников (подтверждение регистрации, измнение регистрации, изменение регистрации, добавление участника в команду, возможность отменить оплату. импорт, экспорт регистраций)
- Управление файлами системы (скачивание, удаление, изменений папок и файлов, добавление новых файлов, состояние хранилища)
- Работа с данными (Импорт спортсменов с примером в формате csv или excel, импорт регитсраций с примером в формате csv или excel, экспорт пользователй, мероприятий, регистраций, команд, статистики и полный экспорт в форматах pdf, csv, excel, системные операции: создание резервной копии бд, очистка временных файлов, логов, удаление докумеентов и файлов 10ти летней давности)
- Классы лодок (отображение, добавление и удаление лодок, через тип enum, редактирование описание класса, статистика использования лодок)
- Статистика администратора ( Сатистика системы, график статуса всех мероприятий, ролей, популярных лодок, статусы в процентах людей с их ролями, статусы в процентах регистраций, техническое описание системы, ьазы данных и дискового пространства)
- Управление профилем

### 3.3 Organizer (userid: 51-150)
- Панель организатора (Статистика мероприятий, последний мероприятия и регистрации)
- Мероприятия (Создание (вручную или заполнение через файл с примером файла), удалениеи редактирование мероприятий, экспорт, работа со статусами)
- Регистрации (Статистика, поиск по статусам, оплате, по мероприятиям, подтверждение участников и команд, подтверждение оплаты, экспорт с примером и импорт регистраций по мероприятиям)
- Управление очередью регистраций (Поиск по статусам, оплате, по мероприятиям, редактирование регистрации, удаление регистраций, подтверждение регистраций, объединение команд, редактирование команд, добавление участников)
- Просмотр календаря мероприятий (список всех меоприятий от лица спортсмена с возможностью подать регистрацию)
- Управление профилем

### 3.4 Secretary (userid: 151-250)
- Главная (Статистика мероприятий для секретаря, инструкции по работе, мероприятия для работы)
- Проведение мероприятий (Панель проведения мероприятий, выбор мероприятия, выбор типа жеребьевки, дисциплины для жеребьевки (одиночны или множественный выбор дисциплин), проведение протколов с импортом одного или всех протоколов, по завершению результаты и формирование призовых мест по дисциплинам и итоговых результатов, дисквалификация участников, обработка результатов соревнований)
- Очередь спортсменов (Поиск по статусам, оплате, по мероприятиям, редактирование регистрации, удаление регистраций, подтверждение регистраций, объединение команд, редактирование команд, добавление участников)
- Управление профилем

### 3.5 Sportsman (userid: 1000+)
- Главная (Стастистика регистраций, призовые места, активные регистрации)
- Календарь (регистрации на мероприятия)
- Управление профилем
- Моя статистика (Просмотр статистики участия, количества медалей, общая статистика)
- Получение уведомлений

## 4. Логика статусов участников

### 4.1 Основные статусы и переходы

#### 4.1.1 Последовательность статусов
1. **"В очереди"** (начальный)
   - Автоматически присваивается при регистрации
   - Участник подал заявку, ожидает подтверждения

2. **"Подтверждён"**
   - Организатор или админ подтверждает участие
   - Участник допущен к соревнованиям

3. **"Зарегистрирован"**
   - Секретарь или админ отмечает прибытие на место
   - Участник фактически присутствует на соревнованиях

4. **"Неявка"**
   - Участник не прибыл на мероприятие
   - Может быть установлен вручную или автоматически

5. **"Дисквалифицирован"**
   - За нарушение правил соревнований
   - Только для зарегистрированных участников

6. **"Ожидание команды"**
   - Для неполных команд (драконы)
   - Автоматически после подтверждения всей команды → "Подтверждён"

### 4.2 Правила управления статусами

#### 4.2.1 Кнопка "Неявка"
**Доступна для:**
- "В очереди"
- "Подтверждён" 
- "Ожидание команды"

**НЕ доступна для:**
- "Зарегистрирован" (уже на месте)
- "Дисквалифицирован" (финальный статус)
- "Неявка" (сама себя)

#### 4.2.2 Кнопка "Дисквалификация"
**Доступна только для:**
- "Зарегистрирован" (только прибывшие участники)

#### 4.2.3 Быстрые переходы статусов
- **"В очереди" → "Подтверждён"** (организатор/админ)
- **"Подтверждён" → "Зарегистрирован"** (секретарь/админ)
- **"Зарегистрирован" → "Дисквалифицирован"** (секретарь/админ)

### 4.3 Автоматические процессы

#### 4.3.1 Автоматическая отметка неявки
- **Триггер**: Через 30 минут после начала мероприятия
- **Обрабатываемые статусы**: "Подтверждён", "В очереди", "Ожидание команды"
- **НЕ обрабатываются**: "Зарегистрирован", "Дисквалифицирован"
- **Частота**: Каждые 30 минут (cron)
- **Уведомления**: Автоматические email + уведомления в ЛК

## 5. Система оплаты и расчет стоимости участия

### 5.1 Принципы расчета стоимости

#### 5.1.1 Драконы (D-10, D-*, лодки-драконы)
- **Принцип**: Команда платит за каждую дистанцию полную стоимость мероприятия
- **Формула**: `(Стоимость мероприятия × Количество дистанций) ÷ Количество участников команды`
- **Размер команды**: Обычно 14 человек (10 гребцов + рулевой + барабанщик + 2 резерва)
- **Пример**: 
  - Стоимость: 7000 ₽
  - Команда на 2 дистанции: (7000 × 2) ÷ 14 = 1000 ₽ на участника

#### 5.1.2 Одиночные лодки (К-1, С-1, *-1)
- **Принцип**: Стоимость остается как указано в мероприятии
- **Формула**: `Стоимость мероприятия`
- **Пример**: При стоимости 6000 ₽ участник платит 6000 ₽

#### 5.1.3 Групповые лодки (К-2, С-2, К-4, С-4)
- **Принцип**: Стоимость делится на количество участников в классе лодки
- **Формула**: `Стоимость мероприятия ÷ Количество участников в классе`
- **Примеры**:
  - К-2: 6000 ÷ 2 = 3000 ₽ на участника
  - К-4: 6000 ÷ 4 = 1500 ₽ на участника

### 5.2 Техническая реализация

#### 5.2.1 Функция расчета
- **PHP**: `calculateParticipantCost($className, $baseCost, $distanceCount, $teamSize)`
- **SQL**: `calculate_participant_cost(class_name, base_cost, distance_count, team_size)`
- **Возвращает**: Стоимость для участника с округлением до 2 знаков

#### 5.2.2 Обновление существующих данных
- **Файл**: `data/db/14_update_payment_costs.sql`
- **Цель**: Пересчет стоимости для всех существующих регистраций
- **Статус**: Выполнено ✅

### 5.3 Примеры расчетов

| Класс лодки | Базовая стоимость | Количество дистанций | Размер команды | Стоимость участника | Примечание |
|-------------|-------------------|---------------------|----------------|-------------------|------------|
| D-10        | 7000 ₽           | 1                   | 14             | 500 ₽             | Дракон на 1 дистанцию |
| D-10        | 7000 ₽           | 2                   | 14             | 1000 ₽            | Дракон на 2 дистанции |
| К-1         | 6000 ₽           | 1                   | 1              | 6000 ₽            | Одиночная байдарка |
| К-2         | 6000 ₽           | 1                   | 2              | 3000 ₽            | Байдарка двойка |
| К-4         | 6000 ₽           | 1                   | 4              | 1500 ₽            | Байдарка четверка |
| С-2         | 6000 ₽           | 1                   | 2              | 3000 ₽            | Каноэ двойка |
  
  ## 6. Структура базы данных

### 6.1 Пользовательские типы данных
```sql
-- Типы лодок
CREATE TYPE boats AS ENUM (
    'D-10', 'K-1', 'K-2', 'K-4', 'C-1', 'C-2', 'C-4', 
    'HD-1', 'OD-1', 'OD-2', 'OC-1'
);

-- Типы прав доступа
CREATE TYPE rights AS ENUM (
    'SuperUser', 'Admin', 'Organizer', 'Secretary', 'Sportsman'
);

-- Статусы регистрации
CREATE TYPE statuses AS ENUM (
    'В очереди', 'Зарегистрирован', 'Подтверждён', 
    'Ожидание команды', 'Дисквалифицирован', 'Неявка'
);

-- Спортивные звания
CREATE TYPE sportzvanias AS ENUM (
    'ЗМС', 'МСМК', 'МССССР', 'МСР', 'МСсуч', 
    'КМС', '1вр', '2вр', '3вр', 'БР'
);

-- Статусы мероприятий
CREATE TYPE merostat AS ENUM (
    'В ожидании', 'Регистрация', 'Регистрация закрыта', 
    'Перенесено', 'Результаты', 'Завершено'
);
```

### 6.2 Основные таблицы

#### users
```sql
CREATE TABLE users (
    oid SERIAL PRIMARY KEY,
    userid INTEGER UNIQUE,
    email TEXT UNIQUE,
    password TEXT,
    fio TEXT,
    sex VARCHAR(1),
    telephone TEXT UNIQUE,
    birthdata DATE,
    country TEXT,
    city TEXT,
    accessrights RIGHTS,
    boats BOATS[],
    sportzvanie SPORTZVANIAS,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

#### meros (мероприятия)
```sql
CREATE TABLE meros (
    oid SERIAL PRIMARY KEY,
    champn INTEGER UNIQUE,
    meroname TEXT,
    merodata TEXT,                    -- Текстовое описание дат проведения
    class_distance JSONB,
    defcost TEXT,
    filepolojenie TEXT,
    fileprotokol TEXT,
    fileresults TEXT,
    status MEROSTAT DEFAULT 'Регистрация',
    created_by INTEGER REFERENCES users(userid),

);
```

**Примечания к полям:**
- **merodata**: Содержит текстовое описание сроков проведения мероприятия (например: "15-17 мая 2024г.", "Июнь 2024")
- **class_distance**: JSONB структура с классами лодок, полом участников и дистанциями
- **status**: Статус мероприятия с возможными пробелами в данных (требует TRIM при обработке)

#### listreg (регистрации)
```sql
CREATE TABLE listreg (
    oid SERIAL PRIMARY KEY,
    userid INTEGER REFERENCES users(userid),
    champn INTEGER REFERENCES meros(champn),
    teamid INTEGER,
    teamname TEXT,
    class_distance JSONB,
    oplata BOOLEAN DEFAULT FALSE,
    cost TEXT,
    status STATUSES DEFAULT 'В очереди',
    role TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

#### teams
```sql
CREATE TABLE teams (
    oid SERIAL PRIMARY KEY,
    teamid INTEGER UNIQUE,
    teamname TEXT,
    teamcity TEXT,
    persons_amount INTEGER,
    persons_all INTEGER,
    another_team INTEGER,
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### notifications
```sql
CREATE TABLE notifications (
    id SERIAL PRIMARY KEY,
    userid INTEGER REFERENCES users(userid),
    title TEXT,
    message TEXT,
    type VARCHAR(50),
    related_id INTEGER,
    is_read BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT NOW()
);
```

### 5.3 Предзаполненные пользователи
```sql
-- SuperUser
INSERT INTO users (userid, email, password, fio, accessrights) VALUES 
(1, 'admin@kgb-pulse.ru', '$2y$10$...', 'SuperUser KGB-Pulse', 'SuperUser');

-- Тестовые администраторы
INSERT INTO users (userid, email, password, fio, accessrights) VALUES 
(2, 'admin1@kgb-pulse.ru', '$2y$10$...', 'Администратор 1', 'Admin'),
(3, 'admin2@kgb-pulse.ru', '$2y$10$...', 'Администратор 2', 'Admin');

-- Тестовые организаторы
INSERT INTO users (userid, email, password, fio, accessrights) VALUES 
(51, 'org1@kgb-pulse.ru', '$2y$10$...', 'Организатор 1', 'Organizer'),
(52, 'org2@kgb-pulse.ru', '$2y$10$...', 'Организатор 2', 'Organizer');

-- Тестовые секретари
INSERT INTO users (userid, email, password, fio, accessrights) VALUES 
(151, 'sec1@kgb-pulse.ru', '$2y$10$...', 'Секретарь 1', 'Secretary'),
(152, 'sec2@kgb-pulse.ru', '$2y$10$...', 'Секретарь 2', 'Secretary');

-- Тестовые спортсмены
INSERT INTO users (userid, email, password, fio, accessrights) VALUES 
(1001, 'sport1@kgb-pulse.ru', '$2y$10$...', 'Спортсмен 1', 'Sportsman'),
(1002, 'sport2@kgb-pulse.ru', '$2y$10$...', 'Спортсмен 2', 'Sportsman');
```

## 6. Функциональные модули

### 6.1 Модуль регистрации участников

#### 6.1.1 Индивидуальная регистрация
- Выбор дисциплин из загруженного файла
- Автоматический расчет стоимости
- Статус "В очереди" по умолчанию

#### 6.1.2 Командная регистрация (драконы)
- Обязательные роли: капитан, рулевой, барабанщик
- Минимум 9 гребцов, максимум 2 резервиста
- Статус "Ожидание команды" для неполных команд
- Автоматический переход в "Подтверждён" при полном составе

### 6.2 Модуль управления мероприятиями

#### 6.2.1 Создание мероприятий
- Загрузка Excel файла с дисциплинами
- Парсинг структуры: класс лодки, дистанция, пол
- Автоматическое формирование регистрационных форм
- Настройка стоимости участия

#### 6.2.2 Структура дисциплин
```json
{
  "D-10": {
    "sex": "MIX", 
    "dist": "10000",
    "age_grpup": ["Открытый класс: 15-39, Синьоры А: 40-59, Синьоры B: 60-150", "Открытый класс: 15-39, Синьоры А: 40-59, Синьоры B: 60-150"]
  },
  "K-1": {
    "sex": ["M", "W"], 
    "dist": ["200, 500, 1000", "200, 500, 1000"],
    "age_grpup": ["группа 1: 27-49, группа 2: 50-59, группа 3: 60-150", "группа 1: 27-49, группа 2: 50-59, группа 3: 60-150"]
  }
} 
```

#### 6.2.3 Структура записи регистрации

#### 6.2.3.1 Одиночная регистрация
```json
{
   "K-1": {"sex": ["M"],  "dist": ["200, 500, 1000"]}
}
```

#### 6.2.3.2 Не одиночная регистрация
На каждую дистанцию создается отдельная запись, на К-2 200 и 500 так
```json
{
   "K-2": {"sex": ["M"],  "dist": ["200"]}
}
```
```json
{
   "K-2": {"sex": ["M"],  "dist": ["200"]}
}
```

### 6.3 Модуль протоколов и результатов

#### 6.3.1 Система проведения мероприятий секретарем

##### 6.3.1.1 Жеребьевка "Полуфиналы и Финалы"
**Принцип работы:**
- Участники разбиваются по классам лодок, дистанциям и возрастным группам
- Возрастные группы рассчитываются на 31 декабря текущего года
- Автоматическое формирование заездов на основе количества участников

**Логика формирования заездов:**
- **Финал**: до 9 участников - сразу финальный заезд
- **Полуфинал**: 9-18 участников - полуфинальные заезды + финал
- **Предварительные**: 18+ участников - предварительные заезды + полуфинал + финал

**Расчет возрастных групп:**
```php
// Возраст рассчитывается на 31.12 текущего года
$age = date('Y') - $birth_year;
$age_group = calculateAgeGroup($age);
```

##### 6.3.1.2 Структура протоколов
**Обязательные поля:**
1. **Вода** - номер дорожки
2. **Номер** - стартовый номер участника
3. **ФИО** - полное имя участника
4. **Год рождения** - для расчета возрастной группы
5. **Возрастная группа** - рассчитывается автоматически
6. **Спортивный разряд** - из профиля участника

**Дополнительные поля:**
- Команда/город (для командных заездов)
- Тренер
- Результат (время)
- Место
- Примечания

##### 6.3.1.3 Хранение данных в Redis
**Ключи Redis для протоколов:**
```redis
# Стартовые протоколы
protocols:start:{mero_id}:{class}:{sex}:{distance}

# Финишные протоколы  
protocols:finish:{mero_id}:{class}:{sex}:{distance}

# Результаты заездов
results:{mero_id}:{class}:{sex}:{distance}:{heat_number}

# Сессия работы секретаря
secretary:session:{user_id}:{mero_id}
```

**Структура данных:**
```json
{
  "protocol_id": "unique_id",
  "mero_id": 123,
  "class": "K-1",
  "sex": "M", 
  "distance": 1000,
  "heat_type": "final|semi|preliminary",
  "heat_number": 1,
  "participants": [
    {
      "lane": 1,
      "start_number": 101,
      "user_id": 1001,
      "fio": "Иванов Иван Иванович",
      "birth_year": 1995,
      "age_group": "Мужчины (взрослые)",
      "sport_rank": "КМС",
      "team": "Спартак Москва",
      "result_time": null,
      "place": null,
      "notes": ""
    }
  ],
  "created_at": "2024-01-15T10:30:00Z",
  "updated_at": "2024-01-15T10:30:00Z"
}
```

#### 6.3.2 Типы протоколов
- **Стартовые протоколы** - формируются перед заездом
- **Финишные протоколы** - заполняются результатами
- **Технические результаты** - сводная таблица по всем заездам
- **Наградные протоколы** - итоговые места по возрастным группам

#### 6.3.3 Шаблоны файлов Excel
**Классификация по типам лодок:**

**Драконы (D-10, D-*):**
- `Start_dragons.xlsx` - стартовые протоколы
- `Finish_dragons.xlsx` - финишные протоколы

**Одиночные лодки (K-1, C-1, *-1):**
- `Start_solo.xlsx` - стартовые протоколы  
- `Finish_solo.xlsx` - финишные протоколы

**Групповые лодки (K-2, C-2, K-4, C-4, 2-10 человек):**
- `Start_group.xlsx` - стартовые протоколы
- `Finish_group.xlsx` - финишные протоколы

**Общие шаблоны:**
- `technical_results.xlsx` - технические результаты

#### 6.3.4 Алгоритм работы секретаря

##### 6.3.4.1 Выбор мероприятия
1. Секретарь выбирает мероприятие со статусом "Регистрация закрыта"
2. Система показывает доступные дисциплины (класс + пол + дистанция)
3. Секретарь выбирает конкретную дисциплину для жеребьевки

##### 6.3.4.2 Создание протоколов
1. **Жеребьевка участников:**
   - Загрузка списка зарегистрированных участников
   - Разбивка по возрастным группам
   - Случайное распределение по дорожкам
   - Формирование заездов (предварительные → полуфинал → финал)

2. **Генерация стартовых протоколов:**
   - Выбор подходящего шаблона (драконы/одиночные/групповые)
   - Заполнение данных участников
   - Экспорт в Excel формате
   - Сохранение в Redis для быстрого доступа

3. **Создание финишных протоколов:**
   - Копирование структуры стартового протокола
   - Добавление полей для результатов
   - Подготовка к вводу времени и мест

##### 6.3.4.3 Ввод результатов
1. **Заполнение финишных протоколов:**
   - Ввод времени для каждого участника
   - Автоматический расчет мест
   - Валидация результатов

2. **Обработка результатов:**
   - Формирование сводных таблиц
   - Определение призеров по возрастным группам
   - Создание наградных протоколов

3. **Экспорт данных:**
   - Технические результаты в Excel
   - Протоколы в PDF
   - Публикация результатов на сайте

#### 6.3.5 Техническая реализация

##### 6.3.5.1 PHP классы для работы с протоколами
```php
class ProtocolManager {
    public function createStartProtocol($meroId, $class, $sex, $distance);
    public function generateHeats($participants, $laneCount = 9);
    public function exportToExcel($protocolData, $templateFile);
    public function saveToRedis($protocolData);
    public function loadFromRedis($protocolId);
}

class ResultProcessor {
    public function calculatePlaces($results);
    public function generateTechnicalResults($meroId);
    public function createAwardProtocols($meroId);
}
```

##### 6.3.5.2 JavaScript для интерфейса секретаря
```javascript
class SecretaryInterface {
    selectDiscipline(class, sex, distance);
    createProtocols();
    enterResults(protocolId);
    validateTimes();
    exportResults();
}
```

### 6.4 Система уведомлений

#### 6.4.1 Уведомления в ЛК
- Изменения статуса регистрации
- Подтверждение участия
- Информация о мероприятиях
- Системные сообщения

#### 6.4.2 Email уведомления
- Подтверждение регистрации
- Изменения статуса ("Подтверждён", "Зарегистрирован")
- Автоматическая отметка неявки
- Дисквалификация

## 7. Интерфейсы пользователей

### 7.1 Админская панель (Admin)
- **Регистрации**: полная таблица с быстрыми кнопками статусов
- **Пользователи**: управление, смена ролей
- **Статистика**: экспорт данных
- **Файлы**: управление загруженными файлами

### 7.2 Панель организатора (Organizer)
- **Мероприятия**: создание, редактирование
- **Очередь**: подтверждение участников и команд
- **Календарь**: просмотр мероприятий

### 7.3 Панель секретаря (Secretary)

#### 7.3.1 Основные разделы интерфейса
- **Главная панель**: статистика мероприятий, быстрый доступ к функциям
- **Проведение мероприятий**: система жеребьевки и создания протоколов
- **Мероприятия**: список доступных для проведения мероприятий
- **Результаты**: обработка финишных данных и публикация результатов
- **Очередь спортсменов**: регистрация участников на месте проведения

#### 7.3.2 Функциональность "Проведение мероприятий"

##### 7.3.2.1 Выбор мероприятия и дисциплины
- Отображение мероприятий со статусом "Регистрация закрыта"
- Просмотр зарегистрированных участников по дисциплинам
- Выбор конкретной дисциплины (класс + пол + дистанция) для жеребьевки
- Отображение количества участников и формирование заездов

##### 7.3.2.2 Система жеребьевки
**Жеребьевка "Полуфиналы и Финалы":**
- Автоматическое распределение участников по возрастным группам
- Формирование заездов на основе количества участников:
  - До 9 участников: сразу финал
  - 9-18 участников: полуфинал + финал  
  - 18+ участников: предварительные + полуфинал + финал
- Случайное распределение по дорожкам (1-9)
- Присвоение стартовых номеров

##### 7.3.2.3 Создание протоколов
**Стартовые протоколы:**
- Автоматический выбор шаблона (драконы/одиночные/групповые)
- Заполнение полей: вода, номер, ФИО, год рождения, возрастная группа, спортивный разряд
- Экспорт в Excel с использованием шаблонов из `/files/template/`
- Сохранение данных в Redis для быстрого доступа

**Финишные протоколы:**
- Копирование структуры стартового протокола
- Добавление полей для ввода результатов (время, место)
- Подготовка интерфейса для ввода данных секретарем

##### 7.3.2.4 Ввод и обработка результатов
**Ввод результатов:**
- Интерфейс для ввода времени каждого участника
- Валидация корректности введенных данных
- Автоматический расчет мест на основе времени
- Возможность добавления примечаний и дисквалификаций

**Обработка данных:**
- Формирование технических результатов по всем заездам
- Определение призеров по возрастным группам
- Создание наградных протоколов
- Экспорт итоговых результатов в Excel и PDF

#### 7.3.3 Управление участниками на месте
- **Регистрация прибывших**: смена статуса "Подтверждён" → "Зарегистрирован"
- **Отметка неявки**: установка статуса "Неявка" для не прибывших
- **Дисквалификация**: снятие участников за нарушения (только для "Зарегистрированных")
- **Просмотр команд**: управление составами команд драконов

#### 7.3.4 Техническая информация
**Хранение данных:**
- Протоколы сохраняются в Redis для быстрого доступа
- Ключи Redis: `protocols:start:{mero_id}:{class}:{sex}:{distance}`
- Результаты: `results:{mero_id}:{class}:{sex}:{distance}:{heat_number}`

**Шаблоны файлов:**
- `Start_dragons.xlsx` / `Finish_dragons.xlsx` - для лодок-драконов
- `Start_solo.xlsx` / `Finish_solo.xlsx` - для одиночных лодок (K-1, C-1)
- `Start_group.xlsx` / `Finish_group.xlsx` - для групповых лодок (K-2, C-2, K-4, C-4)
- `technical_results.xlsx` - для итоговых технических результатов

### 7.4 Личный кабинет (Sportsman)
- **Мероприятия**: регистрация, просмотр доступных
- **Профиль**: редактирование данных
- **Статистика**: история участия

## 8. Техническая реализация

### 8.1 Автоматические задачи (Cron)

#### 8.1.1 Расписание задач
```cron
# Автоматическое закрытие регистрации (каждый день)
0 * * * * php /var/www/html/scripts/auto_close_registration.php

# Автоматическая отметка неявки (каждые 30 минут)
*/30 * * * * php /var/www/html/scripts/auto_mark_no_show.php

# Резервное копирование БД (ежедневно в 02:00)
0 2 * * * sh /var/www/html/scripts/backup_database.sh

# Мониторинг системы (каждые 5 минут)
*/5 * * * * php /var/www/html/scripts/monitor_system.php

# Очистка логов (еженедельно)
0 4 * * 0 sh /var/www/html/scripts/cleanup_logs.sh
```

### 8.2 API Endpoints

#### 8.2.1 Управление статусами
- `POST /lks/php/admin/update_registration_status.php`
- `POST /lks/php/organizer/confirm_participation.php`
- `POST /lks/php/organizer/confirm_team.php`

#### 8.2.2 Данные очереди
- `GET /lks/php/common/get_queue.php`
- `GET /lks/php/secretary/get_protocols.php`

### 8.3 Файловая структура

#### 8.3.1 Организация файлов
```
www/lks/
├── enter/             # Авторизованная зона
│   ├── admin/         # Интерфейс администратора
│   ├── organizer/     # Интерфейс организатора
│   ├── secretary/     # Интерфейс секретаря
│   └── user/          # Личный кабинет спортсмена
├── php/               # Backend API
│   ├── admin/         # API администратора
│   ├── organizer/     # API организатора
│   ├── secretary/     # API секретаря
│   ├── user/          # API пользователя
│   └── common/        # Общие API
├── files/             # Загруженные файлы
│   ├── excel/         # Excel файлы
│   ├── pdf/           # PDF документы
│   ├── template/      # Шаблоны протоколов
│   └── results/       # Результаты соревнований
└── js/                # JavaScript по ролям
    ├── admin/
    ├── organizer/
    ├── secretary/
    └── user/
```

## 9. Безопасность и производительность

### 9.1 Безопасность
- HTTPS соединения (SSL сертификаты)
- Prepared statements для SQL запросов
- CSRF токены для форм
- Валидация данных на сервере
- Хэширование паролей (password_hash)
- Ограничение прав доступа по ролям

### 9.2 Производительность
- Redis кэширование
- Минификация CSS/JS
- Оптимизация изображений
- Индексы БД для частых запросов
- Пагинация больших списков

### 9.3 Мониторинг
- Логирование действий пользователей
- Мониторинг производительности
- Автоматические бэкапы
- Система алертов при ошибках

## 10. Развертывание и поддержка

### 10.1 Docker конфигурация
```yaml
version: '3.8'
services:
  web-server:
    build: ./nginx
    ports: ["80:80", "443:443"]
  
  php-fpm:
    build: ./images/php
    
  database:
    image: postgres:15
    
  redis:
    image: redis:7-alpine
    
  cron:
    build: ./images/cron
```

### 10.2 Обновления системы
- Миграции базы данных
- Обратная совместимость API
- Тестирование перед продакшеном
- Откат при критических ошибках

### 10.3 Резервное копирование
- Ежедневные бэкапы PostgreSQL
- Ежедневные бэкапы Redis
- Годовые архивные копии
- Ротация старых бэкапов

## 11. Текущий статус реализации

### ✅ Полностью реализовано
- Система авторизации и ролей
- Создание и управление мероприятиями
- Регистрация участников (индивидуальная и командная)
- Парсинг Excel файлов с дисциплинами
- Управление статусами участников
- Система уведомлений (ЛК + email)
- Автоматические задачи (cron)
- Интерфейсы для всех ролей
- Экспорт данных и протоколов

### 🔧 Недавние исправления (январь 2025)
- **Исправлены баги интерфейса секретаря:**
  - Добавлена обработка TRIM() для статусов мероприятий в SQL запросах
  - Обновлено меню: "Протоколы" → "Проведение мероприятия"
  - Исправлена статистика на главной странице секретаря
  - Переработан интерфейс main.php с подробными инструкциями
  - Добавлена корректная сортировка мероприятий
  - Улучшено отображение информации о дисциплинах и участниках

### ⚠️ Требует доработки
- Полная реализация восстановления пароля
- Реализация своего почтового сервиса
- Расширенная статистика
- Дополнительные шаблоны протоколов
- Мобильная адаптация интерфейса

### 🚀 Система готова к продакшену
Все ключевые функции реализованы и протестированы. Логика статусов участников полностью соответствует требованиям проведения спортивных соревнований.